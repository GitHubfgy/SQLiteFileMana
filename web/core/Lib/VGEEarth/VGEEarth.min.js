/*! For license information please see VGEEarth.min.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.webpackNumbers=t():e.webpackNumbers=t()}(self,(function(){return function(){"use strict";var e={d:function(t,i){for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r:function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:function(){return Ie}});var i={config:null,version:"1.2",token:null,currentUser:null,viewerLeft:null,viewerRight:null,viewer2D:null,viewerLeftWorkSpace:null,viewerRightWorkSpace:null,viewer2DWorkSpace:null};const n=window,o=n.Cesium,r=n.turf,a=n.proj4,s=n.$;function l(e){function t(e){return e.map((e=>{e.pid=e.pid||(()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?i:7&i|8).toString(16)}))})(),e.disable=e.disable||!1,e.defaultLoad=e.defaultLoad||!1,e.show=e.defaultLoad||!1})),e.filter((e=>!e.disable))}return e.layerList=t(e.layerList),e.terrainList=t(e.terrainList),e.modelList=t(e.modelList),e.cesium3DTileSetList=t(e.cesium3DTileSetList),e.geoJsonList=t(e.geoJsonList),e.poi=t(e.poi),e}var c={getConfig(){const e=window.VGEEarth;let t=e.globeDataCache.config;return t||(window.APPConfig?(t=e.globeDataCache.config=JSON.parse(JSON.stringify(l(window.APPConfig))),document.title=t.appTitle,console.log("%c从全局 script 文件中加载 ：【"+t.appName+"】 的配置文件","color: green;")):(t=e.globeDataCache.config=function(){const e={appName:"VGE工程实验室WebGL平台",appTitle:"VGE",homeAddr:{lon:108.387,lat:30.71,height:15e4},homeBox:{west:120,south:37,east:120,north:37},terrain:"",baseURL:"",GISResources:"",AppResources:"",JavaServer:"",layerList:[{name:"mapbox影像",catalog:"基础数据",dataType:"layer",defaultLoad:!0,properties:{scheme:"layer-xyz-3857",baseLayer:!0,url:"https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXFhYTA2bTMyeW44ZG0ybXBkMHkifQ.gUGbDOPUN1v1fTs5SeOR4A",layers:"cite:polygon_sheng",minimumLevel:7,maximumLevel:15,legend:"",rectangle:{}}}],terrainList:[],modelList:[],cesium3DTileSetList:[],geoJsonList:[],poi:[]};return l(e),e}(),console.log("%c从默认配置文件中加载","color: green;"))),t},getAllSources(){let e=this.getConfig();return[...e.layerList,...e.terrainList,...e.modelList,...e.cesium3DTileSetList,...e.geoJsonList,...e.poi]},getInitialTerrain(){let e=this.getConfig(),t=new o.EllipsoidTerrainProvider({});if(e.terrainList){let i=e.terrainList.find((e=>e.defaultLoad));if(i)if("default"===i.properties.url)t=o.createWorldTerrain({requestWaterMask:!0,requestVertexNormals:!0});else{let e=new o.Resource({url:i.properties.url,queryParameters:{}});t=new o.CesiumTerrainProvider({url:e,requestVertexNormals:!1,requestWaterMask:!1,credit:"VRTheWorldTerrainProvider"===i.properties.provider?"Terrain data courtesy VT M?K":void 0})}}return t},getNameByPid(e){let t=this.getAllSources().find((t=>t.pid===e));return t?t.name:null}},d=function(e,t){let i=new XMLHttpRequest;i.open("GET",e,!1),i.onreadystatechange=function(){if(4==i.readyState&&(200==i.status||304==i.status)){let n={};try{n=JSON.parse(i.responseText)}catch(t){console.log(e,"数据解析错误：",i.responseText)}t(n)}},i.send()},h=class{constructor(e,t){this.viewer=e,this.dataSourceToo=t}createPoint(e){return this.dataSourceToo.entities.add({position:e,point:{color:o.Color.WHITE,pixelSize:5,heightReference:o.HeightReference.NONE}})}PolyLinePrimitive(e){return this.dataSourceToo.entities.add({polyline:{positions:new o.CallbackProperty((function(){return e}),!1),clampToGround:!0,material:new o.PolylineOutlineMaterialProperty({color:o.Color.CHARTREUSE}),width:2}})}PointLabelEntity(e,t){return this.dataSourceToo.entities.add({name:t,position:e,point:{pixelSize:5,color:o.Color.RED,outlineColor:o.Color.WHITE,outlineWidth:2,heightReference:o.HeightReference.NONE},label:{showBackground:!0,horizontalOrigin:o.HorizontalOrigin.LEFT,verticalOrigin:o.VerticalOrigin.BOTTOM,text:t,font:"18px sans-serif",fillColor:o.Color.GOLD,outlineWidth:2,disableDepthTestDistance:1e4}})}lineLabelEntity(e,t){return this.dataSourceToo.entities.add({polyline:{show:!0,positions:e,material:new o.PolylineOutlineMaterialProperty({color:o.Color.RED}),depthFailMaterial:new o.PolylineOutlineMaterialProperty({color:o.Color.RED}),width:2,pixelOffset:new o.Cartesian2(20,-40)},label:{text:t,font:"14pt monospace",color:o.Color.RED,backgroundColor:o.Color.RED,style:o.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,heightReference:o.HeightReference.NONE,verticalOrigin:o.VerticalOrigin.TOP,pixelOffset:new o.Cartesian2(40,-40)}})}spaceDistanceLabel(e,t){let i=this,n=i.viewer,r=new o.Cartesian3;r.x=(e.x+t.x)/2,r.y=(e.y+t.y)/2,r.z=(e.z+t.z)/2;let a=o.Cartographic.fromCartesian(r,o.Ellipsoid.WGS84,new o.Cartographic),s=o.Cartographic.fromCartesian(e,o.Ellipsoid.WGS84,new o.Cartographic),l=o.Cartographic.fromCartesian(t,o.Ellipsoid.WGS84,new o.Cartographic),c=new o.EllipsoidGeodesic;c.setEndPoints(s,l);let d=c.surfaceDistance.toFixed(3);d=d>1e3?(d/1e3).toFixed(3)+"km":d+"m",n.scene.sampleHeightMostDetailed([a]).then((function(e){e[0].height||(e[0].height=0),i.dataSourceToo.entities.add({position:o.Cartographic.toCartesian(e[0],o.Ellipsoid.WGS84,new o.Cartesian3),label:{text:d,font:"21px SimSun",style:o.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,fillColor:o.Color.WHITE,disableDepthTestDistance:5e5,distanceDisplayCondition:5e5}})}))}polygonCenterLabel(e,t="周长"){let i=r.center(e),n="";switch(t){case"周长":{let t=r.length(e,{units:"kilometers"});n=t<5?"周长："+(1e3*t).toFixed(3)+" m":"周长："+t.toFixed(3)+" km"}break;case"面积":{let t=r.area(e);n=t<2e5?"面积："+t.toFixed(3)+" m2":"面积："+(1e-6*t).toFixed(3)+" km2"}}this.dataSourceToo.entities.add({position:o.Cartesian3.fromDegrees(i.geometry.coordinates[0],i.geometry.coordinates[1]),label:{text:n,font:"21px SimSun",style:o.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,fillColor:o.Color.WHITE,disableDepthTestDistance:5e5,distanceDisplayCondition:5e5}})}buildLabel(e,t){return new o.Entity({position:e,label:{text:t,font:"16pt monospace",color:o.Color.RED,backgroundColor:o.Color.RED,style:o.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,heightReference:o.HeightReference.NONE,verticalOrigin:o.VerticalOrigin.TOP,pixelOffset:new o.Cartesian2(30,-30)}})}buildLabelByDegrees(e,t,i={}){let n={position:o.Cartesian3.fromDegrees(e.longitude,e.latitude),label:{text:t,font:"12pt bold monospace",fillColor:o.Color.WHITE,outlineColor:o.Color.BLACK,outlineWidth:4,style:o.LabelStyle.FILL_AND_OUTLINE,horizontalOrigin:o.HorizontalOrigin.LEFT,verticalOrigin:o.VerticalOrigin.BOTTOM,disableDepthTestDistance:Number.POSITIVE_INFINITY,heightReference:o.HeightReference.RELATIVE_TO_GROUND}};for(const e in i)"id"===e?n[e]=i[e]:n.label[e]=i[e];return new o.Entity(n)}buildBillboard(e,t,i){let n={param:JSON.stringify(i),position:o.Cartesian3.fromDegrees(e,t),billboard:{image:i.imgUrl,width:void 0,height:void 0,scaleByDistance:new o.NearFarScalar(150,2,15e6,.5),disableDepthTestDistance:Number.POSITIVE_INFINITY,heightReference:o.HeightReference.RELATIVE_TO_GROUND,verticalOrigin:o.VerticalOrigin.BOTTOM}};return i.name&&(n.param=i.name),i.height&&(n.billboard.height=i.height),i.width&&(n.billboard.width=i.width),new o.Entity(n)}},u=function(e,t,i){let n=o.JulianDate.fromDate(new Date),a=r.length(t,{units:"meters"})/i;e.position=new o.CallbackProperty((function(e){let s=e.secondsOfDay-n.secondsOfDay;if(s<0)return;let l=i*(s%a),c=r.along(t,l,{units:"meters"}).geometry.coordinates;return o.Cartesian3.fromDegrees(c[0],c[1],400)}))};function p(e,t,i){let n=[],o=e.length;for(let t=0;t<o;t++)n[3*t]=e[t][0],n[3*t+1]=e[t][1],3===e[t].length?n[3*t+2]=e[t][2]:n[3*t+2]=22;return new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(Cesium.Cartesian3.fromDegreesArrayHeights(n)),height:1,vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT,clampToGround:!0,classificationType:Cesium.ClassificationType.BOTH,perPositionHeight:!0})}),appearance:new Cesium.EllipsoidSurfaceAppearance({aboveGround:!1,material:new Cesium.Material({fabric:{type:"Water",uniforms:{baseWaterColor:new Cesium.Color(i.color_r,i.color_g,i.color_b,i.color_a),normalMap:t,frequency:i.water_freq,animationSpeed:i.water_animationspeed,amplitude:i.water_amplitude}}})})})}var f="addData",y="removeData",m=class{constructor(e){this.viewer=e,this.nodes=[],this.dataSourceToo=new o.CustomDataSource("工作区-实体集合"),this.viewer.dataSources.add(this.dataSourceToo),this.terrainMana=new class{constructor(e){this.viewer=e,this.sourcesItems=[]}addData(e){let t,i=this.viewer.scene,n=e.properties,r=n.url,a=n.queryParameters||{},s=n.scheme||"CesiumTerrainProvider";if("default"===r)t=o.createWorldTerrain(),i.terrainProvider=t;else{let e=new o.Resource({url:r,queryParameters:a});t=new o[s]({url:e,requestVertexNormals:!1,requestWaterMask:!1,credit:"VRTheWorldTerrainProvider"===s?"Terrain data courtesy VT M?K":void 0}),i.terrainProvider=t}return t}flyToByPid(e){}getByPid(e){}removeByPid(e){return this.removeAll()}removeAll(){return this.viewer.scene.terrainProvider=new o.EllipsoidTerrainProvider({}),!0}}(e),this.layerMana=new class{constructor(e){this.viewer=e,this.sourcesItems=[]}addData(e){let t=e.properties,i=t.url,n=null;switch(t.scheme){case"wms":case"layer-wmts":n=this.addWebMapTileServiceImageryProvider(i,e);break;case"layer-xyz-3857":n=this.addImageryXYZ_3857_Provider(i,e);break;case"layer-xyz-4326":n=this.addImageryXYZ_4326_Provider(i,e);break;case"layer-arcgisMapServer":n=this.addArcGisMapServerImagery(i,e);break;case"layer-geoserver":n=this.addGeoserverWMS(i,e);break;default:return console.log("数据项，缺少图层类型标识符",t),!1}return this.sourcesItems.push(e),!0}getByPid(e){return this.sourcesItems.find((t=>t.name===e))}flyToByPid(e){let t=this.getByPid(e).param.properties.rectangle;this.viewer.camera.flyTo({destination:o.Rectangle.fromDegrees(t.west,t.south,t.east,t.north)})}removeByPid(e){let t=this,i=!1,n=t.sourcesItems.find((t=>t.pid===e));return n?(t.sourcesItems.filter((t=>t!==e)),i=t.viewer.imageryLayers.remove(n),n.isDestroyed()||n.destroy(),i):i}removeAll(){return!1}addWebMapTileServiceImageryProvider(e,t){let i=t.properties.queryParameters||{},n=new o.Resource({url:e,queryParameters:i}),r=new o.WebMapTileServiceImageryProvider({url:n,format:"image/jpeg",show:!1});return this.addImageryProvider(r,t)}addImageryXYZ_3857_Provider(e,t){let i=t.properties.queryParameters||{},n=new o.Resource({url:e,queryParameters:i}),r=new o.UrlTemplateImageryProvider({url:n,tilingScheme:new o.WebMercatorTilingScheme,fileExtension:"png"});return this.addImageryProvider(r,t)}addImageryXYZ_4326_Provider(e,t){let i=t.properties.queryParameters||{},n=new o.Resource({url:e,queryParameters:i}),r=new o.UrlTemplateImageryProvider({url:n,tilingScheme:new o.GeographicTilingScheme({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:1}),fileExtension:"png"});return this.addImageryProvider(r,t)}addArcGisMapServerImagery(e,t){let i=t.properties.queryParameters||{},n=new o.Resource({url:e,queryParameters:i}),r=new o.ArcGisMapServerImageryProvider({url:n,enablePickFeatures:!1});return this.addImageryProvider(r,t)}addGeoserverWMS(e,t){let i=t.properties.queryParameters||{},n=new o.Resource({url:e,queryParameters:i});const r=new o.WebMapServiceImageryProvider({url:n,layers:t.layers,parameters:{service:"WMS",format:"image/png",transparent:!0}});return this.addImageryProvider(r,t)}addImageryProvider(e,t){const i=this.viewer.imageryLayers.addImageryProvider(e);return i.pid=t.pid,i.param=t,t.properties.baseLayer&&this.viewer.imageryLayers.lowerToBottom(i),this.sourcesItems.unshift(i),i}}(e),this.gltfMana=new class{constructor(e){this.viewer=e,this.sourcesItems=[],this.dataSourceToo=new o.CustomDataSource("工作区 GLTF - 附加实体集合"),this.viewer.dataSources.add(this.dataSourceToo)}addData(e){let t=e.properties,i=t.url,n=t.queryParameters||{},a=t.scale||1;this.viewer.scene.globe.depthTestAgainstTerrain=!0;let s=new o.Resource({url:i,queryParameters:n}),l=o.Cartesian3.fromDegrees(t.position.longitude,t.position.latitude,t.position.height||0),c=o.Math.toRadians(135),d=new o.HeadingPitchRoll(c,0,0),h=o.Transforms.headingPitchRollQuaternion(l,d),p={id:e.pid,name:e.name,position:l,orientation:h,model:{uri:s,scale:a,minimumPixelSize:64}};if(null===t.position.height)p.model.heightReference=o.HeightReference.CLAMP_TO_GROUND;else if(t.DistanceDisplayCondition){let e=t.DistanceDisplayCondition.near,i=t.DistanceDisplayCondition.far;p.model.distanceDisplayCondition=new o.DistanceDisplayCondition(e,i)}let f=this.dataSourceToo.entities.add(p);return t.motion&&u(f,r.lineString(t.motion.path),t.motion.speed),this.sourcesItems.unshift(f),f}getByPid(e){return this.sourcesItems.find((t=>t.id===e))}flyToByPid(e){let t=this.sourcesItems.find((t=>t.id===e));this.viewer.flyTo(t,{offset:new o.HeadingPitchRange(0,-1.57,0)})}removeByPid(e){let t=this.viewer.dataSources.remove(this.getByPid(e));return this.sourcesItems=this.sourcesItems.filter((t=>t.id!==e)),this.dataSourceToo.entities.removeById(e),t}removeAll(){return this.sourcesItems.forEach((e=>{this.viewer.dataSources.remove(this.getByPid(e.pid))})),this.sourcesItems=[],!1}}(e),this.poiMana=new class{constructor(e){this.viewer=e,this.sourcesItems=[],this.dataSourceToo=new o.CustomDataSource("工作区 geoJson - 标注点"),this.viewer.dataSources.add(this.dataSourceToo)}addData(e){let t=e.pid,{longitude:i,latitude:n,height:r}=e.properties.position,a=e.properties.text_string,s=e.properties.image_path,l=this.dataSourceToo.entities.add({id:t,name:" mark",position:o.Cartesian3.fromDegrees(i,n),billboard:{show:!0,image:s,width:15,height:15,scaleByDistance:new o.NearFarScalar(150,2,15e6,.5),disableDepthTestDistance:Number.POSITIVE_INFINITY,heightReference:o.HeightReference.RELATIVE_TO_GROUND,verticalOrigin:o.VerticalOrigin.BOTTOM},label:{text:a,font:"12pt bold monospace",fillColor:o.Color.WHITE,outlineColor:o.Color.BLACK,outlineWidth:4,style:o.LabelStyle.FILL_AND_OUTLINE,horizontalOrigin:o.HorizontalOrigin.LEFT,verticalOrigin:o.VerticalOrigin.BOTTOM,pixelOffset:new o.Cartesian2(20,0),disableDepthTestDistance:Number.POSITIVE_INFINITY,heightReference:o.HeightReference.RELATIVE_TO_GROUND}});return this.sourcesItems.push(l),l}getByPid(e){return this.sourcesItems.find((t=>t.id===e))}flyToByPid(e){let t=this.sourcesItems.find((t=>t.id===e));this.viewer.flyTo(t,{offset:new o.HeadingPitchRange(0,-1.57,0)})}removeByPid(e){return this.sourcesItems=this.sourcesItems.filter((t=>t.id!==e)),this.dataSourceToo.entities.removeById(e),!0}removeAll(){return this.dataSourceToo.removeAll(),this.sourcesItems=[],!1}}(e),this._3DTileMana=new class{constructor(e){this.viewer=e,this.sourcesItems=[]}addData(e){let t=e.properties,i=t.url,n=t.queryParameters||{};this.viewer.scene.globe.depthTestAgainstTerrain=!0;let r=new o.Resource({url:i,queryParameters:n}),a=new o.Cesium3DTileset({url:r,show:!0,maximumScreenSpaceError:2,maximumMemoryUsage:4e3,cullWithChildrenBounds:!0,cullRequestsWhileMoving:!1,cullRequestsWhileMovingMultiplier:60,preloadWhenHidden:!0,preloadFlightDestinations:!0,preferLeaves:!0,dynamicScreenSpaceError:!0,dynamicScreenSpaceErrorDensity:.00278,dynamicScreenSpaceErrorFactor:8,dynamicScreenSpaceErrorHeightFalloff:.1,progressiveResolutionHeightFraction:.5,foveatedScreenSpaceError:!0,foveatedConeSize:.1,foveatedMinimumScreenSpaceErrorRelaxation:0,foveatedTimeDelay:.2,skipLevelOfDetail:!0,baseScreenSpaceError:1024,skipScreenSpaceErrorFactor:16,skipLevels:0,immediatelyLoadDesiredLevelOfDetail:!1,loadSiblings:!1,luminanceAtZenith:.2,backFaceCulling:!0,showOutline:!0,vectorClassificationOnly:!1,vectorKeepDecodedPositions:!0,debugFreezeFrame:!1,debugColorizeTiles:!1,debugWireframe:!1,debugShowBoundingVolume:!1,debugShowContentBoundingVolume:!1,debugShowViewerRequestVolume:!1,debugShowGeometricError:!1,debugShowRenderingStatistics:!1,debugShowMemoryUsage:!1,debugShowUrl:!1});return a.pid=e.pid,a.param=t,this.sourcesItems.unshift(a),a=this.viewer.scene.primitives.add(a),a.readyPromise.then((function(e){let i=t.offset;i&&function(e,t){if(t.longitude&&!isNaN(t.longitude)&&t.latitude&&!isNaN(t.latitude)&&t.height&&!isNaN(t.height)){let i=e.boundingSphere.center,n=o.Cartesian3.fromDegrees(t.longitude,t.latitude,t.height),r=o.Transforms.eastNorthUpToFixedFrame(i),a=o.Matrix4.getMatrix3(r,new o.Matrix3),s=o.Matrix3.inverse(a,new o.Matrix3),l=new o.Cartesian3(-i.x,-i.y,-i.z),c=o.Transforms.eastNorthUpToFixedFrame(n);c=o.Matrix4.multiplyByMatrix3(c,s,new o.Matrix4),c=o.Matrix4.multiplyByTranslation(c,l,new o.Matrix4),e.modelMatrix=c}if(!t.longitude&&!t.latitude&&t.height&&!isNaN(t.height)){let i=o.Cartographic.fromCartesian(e.boundingSphere.center),n=o.Cartesian3.fromRadians(i.longitude,i.latitude,t.height),r=e.boundingSphere.center,a=new o.Cartesian3;o.Cartesian3.subtract(n,r,a),e.modelMatrix=o.Matrix4.fromTranslation(a)}}(e,i)})),a}flyToByPid(e){let t=this.sourcesItems.find((t=>t.pid===e));this.viewer.flyTo(t,{offset:new o.HeadingPitchRange(0,-1.57,0)})}getByPid(e){return this.sourcesItems.find((t=>t.name===e))}removeByPid(e){let t=this.sourcesItems.find((t=>t.pid===e));return t&&!t.isDestroyed()&&t.destroy(),this.sourcesItems=this.sourcesItems.filter((t=>t.pid!==e)),this.viewer.scene.primitives.remove(t)}removeAll(){return this.sourcesItems.forEach((e=>{this.viewer.dataSources.remove(this.getByPid(e.pid))})),this.sourcesItems=[],!1}}(e),this.geoJsonMana=new class{constructor(e){this.viewer=e,this.sourcesItems=[],this.dataSourceToo=new o.CustomDataSource("工作区 geoJson - 附加实体集合"),this.entityFactory=new h(e,this.dataSourceToo),this.viewer.dataSources.add(this.dataSourceToo)}addData(e){let t=this,i=e.properties,n=i.url,a=e.pid;return d(n,(n=>{if(i.label){let e=r.center(n).geometry.coordinates,s={id:a};i.label.pixelOffset&&(s.pixelOffset=new o.Cartesian2(i.label.pixelOffset.x,i.label.pixelOffset.y));let l=t.entityFactory.buildLabelByDegrees({longitude:e[0],latitude:e[1],height:0},i.label.text,s);this.dataSourceToo.entities.add(l)}let s=new o.GeoJsonDataSource;s.id=a,s.load(n,{clampToGround:!0}).then((function(t){s.name=e.pid,s.nikeName=e.name,t.entities.values.forEach((e=>{i.symbol.lineArrow&&e.polyline&&(e.polyline.material=new o.PolylineArrowMaterialProperty(o.Color.RED),e.polyline.width=15)}))})),s.name=e.pid,s.nikeName=e.name,t.sourcesItems.push(s),t.viewer.dataSources.add(s)})),!0}getByPid(e){return this.sourcesItems.find((t=>t.id===e))}flyToByPid(e){let t=this.sourcesItems.find((t=>t.id===e));this.viewer.flyTo(t,{offset:new o.HeadingPitchRange(0,-1.57,0)})}removeByPid(e){let t=this.viewer.dataSources.remove(this.getByPid(e));return this.sourcesItems=this.sourcesItems.filter((t=>t.id!==e)),this.dataSourceToo.entities.removeById(e),t}removeAll(){return this.sourcesItems.forEach((e=>{this.viewer.dataSources.remove(this.getByPid(e.pid))})),this.sourcesItems=[],!1}}(e),this.waterMana=new class{constructor(e){this.viewer=e,this.sourcesItems=[],this.options={color_r:0,color_g:.2941177,color_b:.2078431,color_a:1,water_freq:100,water_animationspeed:.01,water_amplitude:2},this.primitives=[]}addData(e){let t=this,i=e.properties,n=JSON.parse(JSON.stringify(i.waterOptions));!n.color_r&&(n.color_r=t.options.color_r),!n.color_g&&(n.color_g=t.options.color_g),!n.color_b&&(n.color_b=t.options.color_b),!n.color_a&&(n.color_a=t.options.color_a),!n.water_freq&&(n.water_freq=t.options.water_freq),!n.water_animationspeed&&(n.water_animationspeed=t.options.water_animationspeed),!n.water_amplitude&&(n.water_amplitude=t.options.water_amplitude);let o=n.geoJsonUrl,r=n.textureUrl;return this.getByPid(e.pid)?(console.log("不允许重复添加"),!1):(t.sourcesItems.push(e),d(o,(function(i){(function(e,t,i){let n=[],o=e.features;for(let e=0;e<o.length;e++){let r=p(o[e].geometry.coordinates[0],t,i);n.push(r)}return n})(i,r,n).forEach((i=>{i.pid=e.pid,t.viewer.scene.primitives.add(i),t.primitives.push(i)}))})),!0)}reLoad(){let e=JSON.parse(JSON.stringify(this.sourcesItems));this.removeAll(),e.forEach((e=>{this.addData(e)}))}flyToByPid(e){}getByPid(e){return this.sourcesItems.find((t=>t.name===e))}removeAll(){let e=this;return e.primitives.forEach((t=>e.viewer.scene.primitives.remove(t))),e.sourcesItems=[],!0}removeByPid(e){let t=this;return t.primitives.filter((t=>t.pid===e)).forEach((e=>t.viewer.scene.primitives.remove(e))),this.sourcesItems=this.sourcesItems.filter((t=>t.pid!==e)),!0}}(e),this.sourceEvent=new class{constructor(){this.listenCallbacks=[]}addEventListener(e,t,i){return!this.listenCallbacks.find((n=>n.listenType===e&&n.callback===t&&n.scope===i))&&(this.listenCallbacks.push({listenType:e,callback:t,scope:i}),!0)}triggerEvent(e,t){this.listenCallbacks.forEach((i=>{i.listenType===e&&("function"==typeof i.callback?i.callback(t):console.log("无法触发监听方法：",i.callback))}))}removeListen(e){return!!this.listenCallbacks.find((t=>t.callback===e))&&(this.listenCallbacks=this.listenCallbacks.filter((t=>t.callback!==e)),!0)}},this.listenSource()}listenSource(){let e=this;e.viewer.scene.globe.imageryLayersUpdatedEvent.addEventListener((function(){setTimeout((()=>{e.nodes.forEach((t=>{"layer"===t.dataType&&!e.viewer.imageryLayers._layers.find((e=>(e.param||{}).pid===t.pid))&&e.removeData(t)}))}),50)}))}addData(e){let t=this,i=null;if(!t.checkSourceItem(e))return console.log("该资源项不合法",e),i;if(e=JSON.parse(JSON.stringify(e)),this.nodes.find((t=>e.pid===t.pid)))return console.warn("工作区已加载该数据!不允许重复加载：",e.name),i;switch(console.log("%c正在加载数据："+e.name,"color:green"),e.dataType){case"layer":i=t.layerMana.addData(e);break;case"dem":i=t.terrainMana.addData(e);break;case"gltf":i=t.gltfMana.addData(e);break;case"3DTiles":i=t._3DTileMana.addData(e);break;case"geoJson":i=t.geoJsonMana.addData(e);break;case"water":i=t.waterMana.addData(e);break;case"poi":i=t.poiMana.addData(e)}return this.nodes.push(e),t.sourceEvent.triggerEvent(f,e),i}removeData(e){let t=this,i=!1;if(e){switch(t.nodes.find((t=>e.pid===t.pid))&&void 0!==e.pid?console.warn("正在执行移除!"):console.error("正在执行重复移除!"),e.dataType){case"layer":i=t.layerMana.removeByPid(e.pid);break;case"dem":t.terrainMana.removeByPid(e.pid);break;case"3DTiles":i=t._3DTileMana.removeByPid(e.pid);break;case"geoJson":i=t.geoJsonMana.removeByPid(e.pid);break;case"water":i=t.waterMana.removeByPid(e.pid);break;case"gltf":i=t.gltfMana.removeByPid(e.pid);break;case"poi":i=t.poiMana.removeByPid(e.pid)}t.nodes=t.nodes.filter((t=>t.pid!==e.pid)),t.sourceEvent.triggerEvent(y,e),console.log(e.dataType+"移除 "+i)}}flyToData(e){let t=this;if(this.nodes.find((t=>e.pid===t.pid)))switch(e.dataType){case"layer":case"dem":break;case"3DTiles":t._3DTileMana.flyToByPid(e.pid);break;case"geoJson":t.geoJsonMana.flyToByPid(e.pid);break;case"water":t.waterMana.flyToByPid(e.pid);break;case"gltf":t.gltfMana.flyToByPid(e.pid);break;case"poi":t.poiMana.flyToByPid(e.pid)}}checkSourceItem(e){let t=!0;return t=t&&!!e,t=t&&!!e.pid,t=t&&!!e.properties,t}},g={getCameraHeight(){let e=i.viewerLeft.scene,t=e.canvas.clientWidth,n=e.canvas.clientHeight,r=e.camera.getPickRay(new o.Cartesian2(t/2|0,n-1)),a=e.camera.getPickRay(new o.Cartesian2(1+t/2|0,n-1)),s=e.globe,l=s.pick(r,e),c=s.pick(a,e);function d(e){return null!=e}if(!d(l)||!d(c))return NaN;let h=s.ellipsoid.cartesianToCartographic(l),u=s.ellipsoid.cartesianToCartographic(c),p=new o.EllipsoidGeodesic;return p.setEndPoints(h,u),100*p.surfaceDistance},getTerrainMostDetailedHeight(e,t){let i=o.createWorldTerrain();o.sampleTerrainMostDetailed(i,[e]).then((function(e){"function"==typeof t&&t(e[0])}))},fullScreen(){let e=i.viewerLeft;o.Fullscreen.requestFullscreen(e.scene.canvas)},globalView(){i.viewerLeft.camera.flyHome(1)},trueNorth(){let e=i.viewerLeft,t=o.Cartographic.fromCartesian(e.camera.position,o.Ellipsoid.WGS84,new o.Cartographic),n=e.scene.pickPosition(new o.Cartesian2(e.canvas.clientWidth/2,e.canvas.clientHeight/2)),r=o.Cartographic.fromCartesian(n,o.Ellipsoid.WGS84,new o.Cartographic);r.height=t.height;let a=o.Cartographic.toCartesian(r,o.Ellipsoid.WGS84,new o.Cartesian3);e.camera.setView({destination:a,orientation:{heading:o.Math.toRadians(0),pitch:e.camera.pitch,roll:e.camera.roll}})},verticalView(){let e=i.viewerLeft,t=o.Cartographic.fromCartesian(e.camera.position,o.Ellipsoid.WGS84,new o.Cartographic),n=e.scene.pickPosition(new o.Cartesian2(e.canvas.clientWidth/2,e.canvas.clientHeight/2)),r=o.Cartographic.fromCartesian(n,o.Ellipsoid.WGS84,new o.Cartographic);r.height=t.height;let a=o.Cartographic.toCartesian(r,o.Ellipsoid.WGS84,new o.Cartesian3);e.camera.setView({destination:a,orientation:{heading:e.camera.heading,pitch:o.Math.toRadians(-90),roll:e.camera.roll}})},lockVerticalView(){let e=i.viewerLeft;!0===e.scene.screenSpaceCameraController.enableTilt?(this.verticalView(),e.scene.screenSpaceCameraController.enableTilt=!1):e.scene.screenSpaceCameraController.enableTilt=!0},doubleViewer(){},shutterView(){},spaceDistance(){},surfaceArea(){},TriangleDistance(){},verticalDistance(){},viewPointManage(){},surroundBrowse(){},flyView(){},viewShed(){},openPDF(){window.open("_blank").location.href="用户手册.pdf"},viewerCapture(){let e=i.viewerLeft.scene.canvas.toDataURL("image/png"),t=atob(e.split(",")[1]),n=t.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=t.charCodeAt(e);let r=document.createElement("a");r.download="scene.png",r.href=URL.createObjectURL(new Blob([o])),r.click()},runFunByName(e){"fullScreen"===e?this.fullScreen():"trueNorth"===e?this.trueNorth():"verticalView"===e?this.verticalView():"lockVerticalView"===e?this.lockVerticalView():"doubleViewer"===e?this.doubleViewer():"shutterView"===e?this.shutterView():"spaceDistance"===e?this.spaceDistance():"surfaceArea"===e?this.surfaceArea():"TriangleDistance"===e?this.TriangleDistance():"verticalDistance"===e?this.verticalDistance():"viewPointManage"===e?this.viewPointManage():"surroundBrowse"===e?this.surroundBrowse():"flyView"===e?this.flyView():"viewShed"===e?this.viewShed():"surfaceTransparent"===e||("openPDF"===e?this.openPDF():"viewerCapture"===e?this.viewerCapture():"resetMap"===e||console.log("未识别的操作"))}},w=class{constructor(e){let t=this;this.listenCallbacks=[],new o.ScreenSpaceEventHandler(e.scene.canvas).setInputAction((function(i){let n=e.scene.pick(i.position);o.defined(n)&&t.triggerEvent(n)}),o.ScreenSpaceEventType.LEFT_CLICK)}addEventListener(e,t,i){return!this.listenCallbacks.find((n=>n.listenType===e&&n.callback===t&&n.scope===i))&&(this.listenCallbacks.push({listenType:e,callback:t,scope:i}),!0)}triggerEvent(e){this.listenCallbacks.forEach((t=>{"function"==typeof t.callback?t.callback(e):console.log("无法触发监听方法：",t.callback)}))}removeListen(e){return!!this.listenCallbacks.find((t=>t.callback===e))&&(this.listenCallbacks=this.listenCallbacks.filter((t=>t.callback!==e)),!0)}},b=function(e){let t=c.getConfig();e.scene.globe.baseColor=o.Color.BLACK,e._cesiumWidget._creditContainer.style.display="none",e.camera.DEFAULT_VIEW_RECTANGLE=o.Rectangle.fromDegrees(t.homeBox.west,t.homeBox.south,t.homeBox.east,t.homeBox.north),t&&t["viewer.resolutionScale"]&&(e.resolutionScale=t["viewer.resolutionScale"]),e.scene.camera.setView({destination:o.Cartesian3.fromDegrees(t.homeAddr.lon,t.homeAddr.lat,t.homeAddr.height)}),e.scene.fxaa=!0,e.scene.postProcessStages.fxaa.enabled=!0,o.FeatureDetection.supportsImageRenderingPixelated()&&(e.resolutionScale=window.devicePixelRatio)},C={createViewer(e,t=!0){!function(e){let t=document.getElementById(e);t.innerHTML="",t.style.position="absolute";let i=document.createElement("div");i.style.display="flex",i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.style.minWidth="500px",i.style.minHeight="400px",t.appendChild(i);let n=document.createElement("div"),o=document.createElement("div");n.setAttribute("id","viewer3DDom"),o.setAttribute("id","viewer2DDom"),n.style.height="100%",o.style.height="100%",n.style.width="100%",o.style.width="100%",n.style.display="inline-block",o.style.display="inline-block",i.appendChild(n),i.appendChild(o)}(e);let i={homeButton:!1,fullscreenButton:!1,sceneModePicker:!1,clockViewModel:new o.ClockViewModel,infoBox:!1,geocoder:!1,sceneMode:o.SceneMode.SCENE2D,navigationHelpButton:!1,animation:!1,timeline:!1,baseLayerPicker:!1},n=new o.Viewer("viewer3DDom",{animation:!1,homeButton:!1,geocoder:!1,baseLayerPicker:!1,timeline:!1,fullscreenButton:!1,scene3DOnly:!0,infoBox:!0,sceneModePicker:!1,navigationInstructionsInitiallyVisible:!1,navigationHelpButton:!1,selectionIndicator:!1,vrButton:!0,shadows:!1,shouldAnimate:!0,contextOptions:{webgl:{preserveDrawingBuffer:!0}}}),r=new o.Viewer("viewer2DDom",i);return b(n),b(r),n.camera.changed.addEventListener(function(e,t){let i,n;return function(){let r=new o.Cartesian2(Math.floor(e.canvas.clientWidth/2),Math.floor(e.canvas.clientHeight/2)),a=e.scene.camera.pickEllipsoid(r);o.defined(a)&&(i=a),n=o.Cartesian3.distance(i,e.scene.camera.positionWC),t.scene.camera.lookAt(i,new o.Cartesian3(0,0,n))}}(n,r)),n.camera.percentageChanged=.01,function(e){document.getElementById("viewer2DDom").style.display="none",e.scene.screenSpaceCameraController.enableRotate=!1,e.scene.screenSpaceCameraController.enableTranslate=!1,e.scene.screenSpaceCameraController.enableZoom=!1,e.scene.screenSpaceCameraController.enableTilt=!1,e.scene.screenSpaceCameraController.enableLook=!1}(r),this.loadSource({viewer3D:n,viewer2D:r}),this.initEvent(n),{viewer3D:n,viewer2D:r}},createNavigation(e){!e&&(e=i.viewerLeft);let t=c.getConfig(),n={defaultResetView:o.Rectangle.fromDegrees(t.homeBox.west,t.homeBox.south,t.homeBox.east,t.homeBox.north),enableCompass:!0,enableZoomControls:!0,enableDistanceLegend:!0,enableCompassOuterRing:!0};e.extend(o.viewerCesiumNavigationMixin,n)},loadSource({viewer3D:e,viewer2D:t}){const n=i;n.viewerLeft=e,n.viewer2D=t,n.viewerLeftWorkSpace=new m(e),n.viewer2DWorkSpace=new m(t),e.imageryLayers.removeAll(),t.imageryLayers.removeAll(),c.getAllSources().forEach((e=>{!e.defaultLoad||"layer"!==e.dataType&&"dem"!==e.dataType||(n.viewerLeftWorkSpace.addData(e),n.viewer2DWorkSpace.addData(e))})),setTimeout((function(){c.getAllSources().forEach((e=>{e.defaultLoad&&"layer"!==e.dataType&&"dem"!==e.dataType&&(n.viewerLeftWorkSpace.addData(e),n.viewer2DWorkSpace.addData(e))}))}),2e3)},toggle2DShow(){s("#viewer2DDom").toggle(),s("#viewer3DDom").width="50%",s("#viewer2DDom").width="50%"},initEvent(e){i.screenEvent=new w(e)},open2D3D(){document.getElementById("viewer2DDom").style.display="inline-block"},close2D3D(){document.getElementById("viewer2DDom").style.display="none"},openDeBug(e){!e&&(e=i.viewerLeft),e.scene.debugShowFramesPerSecond=!0},closeDeBug(e){!e&&(e=i.viewerLeft),e.scene.debugShowFramesPerSecond=!1},initMonitorCoordinates({viewer:e,moveFun:t}){!e&&(e=i.viewerLeft);let n=e.scene.canvas,r=e.scene.globe.ellipsoid,a=new o.ScreenSpaceEventHandler(n),s=0,l=0,c=0,d=0,h=!0,u=!0;a.setInputAction((function(i){let n=e.camera.pickEllipsoid(i.endPosition,r);if(n){let t=e.scene.globe.ellipsoid.cartesianToCartographic(n);s=o.Math.toDegrees(t.longitude),l=o.Math.toDegrees(t.latitude),h=!0}else h=!1;e.terrainProvider instanceof o.EllipsoidTerrainProvider||u&&(u=!1,g.getTerrainMostDetailedHeight(o.Cartographic.fromDegrees(s,l),(function(e){u=!0,c=e.height}))),d=g.getCameraHeight()||3e6,h&&"function"==typeof t&&t(s,l,c,d)}),o.ScreenSpaceEventType.MOUSE_MOVE),a.setInputAction((function(){d=g.getCameraHeight()||3e6,h&&"function"==typeof t&&t(s,l,c,d)}),o.ScreenSpaceEventType.WHEEL)}};let v,S,P,E,T={},D={};function M(e){v&&!v.isDestroyed()||T[o.ScreenSpaceEventType.LEFT_CLICK]&&T[o.ScreenSpaceEventType.LEFT_CLICK].forEach((t=>{t.callback(e,t.scope)}))}function k(e){S&&!S.isDestroyed()||D[o.ScreenSpaceEventType.LEFT_CLICK]&&D[o.ScreenSpaceEventType.LEFT_CLICK].forEach((t=>{t.callback(e,t.scope)}))}function I(e){v&&!v.isDestroyed()||T[o.ScreenSpaceEventType.MOUSE_MOVE]&&T[o.ScreenSpaceEventType.MOUSE_MOVE].forEach((t=>{t.callback(e,t.scope)}))}function L(e){S&&!S.isDestroyed()||D[o.ScreenSpaceEventType.MOUSE_MOVE]&&D[o.ScreenSpaceEventType.MOUSE_MOVE].forEach((t=>{t.callback(e,t.scope)}))}var _={getHandle:(e,t)=>({handler:new o.ScreenSpaceEventHandler(e.canvas),errCallback:t||function(){console.log("默认事件监听器，被重置！")}}),getRuntimeHandle(e,t,n){let r;return e===i.viewerLeft?(v&&!v.isDestroyed()&&(v.errCallback&&"function"==typeof v.errCallback&&(v.errCallback(v.errCallbackScope),delete v.errCallbackScope,delete v.errCallback),v.destroy()),v=new o.ScreenSpaceEventHandler(e.canvas),v.errCallback=t,v.errCallbackScope=n,r=v):i.viewerRight&&e===i.viewerRight&&(S&&!S.isDestroyed()&&(S.errCallback&&"function"==typeof S.errCallback&&(S.errCallback(S.errCallbackScope),delete S.errCallbackScope,delete S.errCallback),S.destroy()),S=new o.ScreenSpaceEventHandler(e.canvas),S.errCallback=t,S.errCallbackScope=n,r=S),r},addEventListener(e,t,n,r){e===i.viewerLeft&&(P||(P=new o.ScreenSpaceEventHandler(e.canvas),P.setInputAction(M,o.ScreenSpaceEventType.LEFT_CLICK),P.setInputAction(I,o.ScreenSpaceEventType.MOUSE_MOVE)),T[n]||(T[n]=[]),"function"==typeof t?T[n].push({callback:t,scope:r}):console.log("注册失败！")),e===i.viewerRight&&(E||(E=new o.ScreenSpaceEventHandler(e.canvas),E.setInputAction(k,o.ScreenSpaceEventType.LEFT_CLICK),E.setInputAction(L,o.ScreenSpaceEventType.MOUSE_MOVE)),D[n]||(D[n]=[]),"function"==typeof t?D[n].push({callback:t,scope:r}):console.log("注册失败！"))}};let B={DeltaDegree:1e-5,DeltaRadian:1e-5*Math.PI/180,getBlankViewer:()=>new o.Viewer(document.createElement("div")),lat_to_meter:e=>e/1.57891e-7,lon_to_meter:(e,t)=>e/1.56785e-7*Math.cos(t),meter_to_lat:e=>1.57891e-7*e,meter_to_long:(e,t)=>1.56785e-7*e/Math.cos(t),cartesianToCartographicObj:function(e){let t=this.getBlankViewer(),i=[];for(let n=0;n<e.length;n++){let r=t.scene.globe.ellipsoid,a=new o.Cartesian3(e[n].x,e[n].y,e[n].z),s=r.cartesianToCartographic(a),l={longitude:o.Math.toDegrees(s.longitude),latitude:o.Math.toDegrees(s.latitude),height:s.height};i.push(l)}return i},cartesianToCartographicArr:function(e){let t=this.getBlankViewer(),i=[];for(let n=0;n<e.length;n++){let r=t.scene.globe.ellipsoid,a=new o.Cartesian3(e[n].x,e[n].y,e[n].z),s=r.cartesianToCartographic(a);i.push(s.longitude/Math.PI*180),i.push(s.latitude/Math.PI*180),i.push(s.height)}return i},cartesianToCartographicPoiArr:function(e){let t=this.getBlankViewer(),i=[];for(let n=0;n<e.length;n++){let r=t.scene.globe.ellipsoid,a=new o.Cartesian3(e[n].x,e[n].y,e[n].z),s=r.cartesianToCartographic(a);i.push([s.longitude/Math.PI*180,s.latitude/Math.PI*180,s.height])}return i},pointProjectLine:function(e,t,i,n,o,r,a){if(x(i,n,o,r,1e-7))return a[0]=i,a[1]=n,0;if(x(i,n,e,t,1e-7)||x(o,r,e,t,1e-7))return a[0]=e,a[1]=t,0;let s=this.TwoPointsDistance(i,n,e,t),l=this.vecAngle(i,n,o,r),c=this.TwoPointsDistance(i,n,o,r),d=l-this.vecAngle(i,n,e,t),h=Math.cos(d)*s;return a[0]=i+Math.cos(l)*h,a[1]=n+Math.sin(l)*h,h<0?-1:h<=c?0:1},TwoPointsDistance:(e,t,i,n)=>Math.sqrt((e-i)*(e-i)+(t-n)*(t-n)),vecAngle:function(e,t,i,n){let o,r;return o=i-e,r=n-t,this.normalizeVecAngle(Math.atan2(r,o))},normalizeVecAngle:e=>e-~~(e/(2*Math.PI))*(2*Math.PI),polarPoint:function(e,t,i,n){let o=new Array(2);return o[0]=e+n*Math.cos(i),o[1]=t+n*Math.sin(i),o},polygonRefDot:function(e){let t=e.coordinates;"MultiPolygon"==e.type&&(t=e.coordinates[0]);let i=new Float64Array([9999,9999,-9999,-9999]);for(let e=0;e<t.length;e++){let n=t[e];for(let e=0;e<n.length;e++)n[e][0]<i[0]&&(i[0]=n[e][0]),n[e][0]>i[2]&&(i[2]=n[e][0]),n[e][1]<i[1]&&(i[1]=n[e][1]),n[e][1]>i[3]&&(i[3]=n[e][1])}if(i[2]-i[0]<1e-13||i[3]-i[1]<1e-13)return new Float64Array([(i[0]+i[2])/2,(i[1]+i[3])/2]);let n,o=(i[0]+i[2])/2,r=[];for(let e=0;e<t.length;e++){let i=t[e];for(let e=0;e<i.length-1;e++){if(i[e][0]<=i[e+1][0]){if(o<i[e][0]||o>=i[e+1][0])continue}else if(o<=i[e+1][0]||o>i[e][0])continue;n=i[e][1]+(i[e+1][1]-i[e][1])*(o-i[e][0])/(i[e+1][0]-i[e][0]),r.push(n)}}return r.sort(),n=(r[0]+r[1])/2,new Float64Array([o,n])},deltaAngle:function(e,t){return this.normalizeVecAngle(t-e)},InterpolateLineLonlat:function(e,t){if(!e||!t)return null;if(!(e.lon&&e.lat&&t.lon&&t.lat))return null;if(!(O(e.lon)&&O(t.lon)&&A(e.lat)&&A(t.lat)))return null;let i=[];i.push([e.lon,e.lat]);let n=Math.sqrt(Math.pow(t.lon-e.lon,2)+Math.pow(t.lat-e.lat,2));if(n<=this.DeltaDegree)return i.push([t.lon,t.lat]),i;{let o=n/this.DeltaDegree,r=(t.lon-e.lon)/o,a=(t.lat-e.lat)/o;for(let t=0;t<o;t++){let n=e.lon+(t+1)*r,o=e.lat+(t+1)*a;i.push([n,o])}}return i},InterpolateLineCartographic:function(e,t,i){if(!e||!t)return null;if(!(e.longitude&&e.latitude&&t.longitude&&t.latitude))return null;let n=[];n.push(new o.Cartographic(e.longitude,e.latitude));let r=Math.sqrt(Math.pow(t.longitude-e.longitude,2)+Math.pow(t.latitude-e.latitude,2)),a=i&&"number"==typeof i?i:this.DeltaRadian;if(r<=a)return n.push(new o.Cartographic(t.longitude,t.latitude)),n;{let i=r/a,s=(t.longitude-e.longitude)/i,l=(t.latitude-e.latitude)/i;for(let t=0;t<i;t++){let i=e.longitude+(t+1)*s,r=e.latitude+(t+1)*l;n.push(new o.Cartographic(i,r))}n.push(new o.Cartographic(t.longitude,t.latitude,t.height))}return n},InterpolateLineHeightCartographic:function(e,t){if(!e||!t)return null;if(!(e.longitude&&e.latitude&&t.longitude&&t.latitude))return null;let i=[];i.push(new o.Cartographic(e.longitude,e.latitude,e.height));let n=Math.sqrt(Math.pow(t.longitude-e.longitude,2)+Math.pow(t.latitude-e.latitude,2));if(n<=this.DeltaRadian)return i.push(new o.Cartographic(t.longitude,t.latitude,t.height)),i;{let r=n/this.DeltaRadian,a=(t.longitude-e.longitude)/r,s=(t.latitude-e.latitude)/r,l=(t.height-e.height)/r;for(let t=0;t<r;t++){let n=e.longitude+(t+1)*a,r=e.latitude+(t+1)*s,c=e.height+(t+1)*l;i.push(new o.Cartographic(n,r,c))}i.push(new o.Cartographic(t.longitude,t.latitude,t.height))}return i},interpolate2IndexLineHeightCartographic:function(e,t,i,n){if(!e||!t)return null;if(!(e.longitude&&e.latitude&&t.longitude&&t.latitude))return null;let r=[];r.push(new o.Cartographic(e.longitude,e.latitude,e.height));let a=(t.longitude-e.longitude)/i,s=(t.latitude-e.latitude)/i,l=(t.height-e.height)/i;for(let t=0;t<n;t++){let i=e.longitude+(t+1)*a,n=e.latitude+(t+1)*s,c=e.height+(t+1)*l;r.push(new o.Cartographic(i,n,c))}return r},interpolateIndexLineHeightCartographic:function(e,t,i,n){if(!e||!t)return null;if(!(e.longitude&&e.latitude&&t.longitude&&t.latitude))return null;let r=(t.longitude-e.longitude)/i,a=(t.latitude-e.latitude)/i,s=(t.height-e.height)/i,l=e.longitude+n*r,c=e.latitude+n*a,d=e.height+n*s;return new o.Cartographic(l,c,d)},lonLat2WebMercator:function(e,t,i){return i||(i=[]),i[0]=20037508.34*e/180,i[1]=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180),i[1]=20037508.34*i[1]/180,i},webMercator2LonLat:function(e,t,i){return i||(i=[]),i[0]=e/20037508.34*180,i[1]=t/20037508.34*180,i[1]=180/Math.PI*(2*Math.atan(Math.exp(i[1]*Math.PI/180))-Math.PI/2),i},lonLat2GaussKruger3:function(e,t){let i=Math.floor(e/3);return a("+proj=longlat +datum=WGS84 +no_defs ","+proj=tmerc +lat_0=0 +lon_0="+3*i+" +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs").forward([e,t])},computeLineNormal:function(e,t,i,n,r){let a=this.lon_to_meter(e,t),s=this.lat_to_meter(t),l=this.lon_to_meter(i,n),c=this.lat_to_meter(n),d=(a+l)/2,h=(s+c)/2,u=this.vecAngle(a,s,l,c)-Math.PI/2,p=this.polarPoint(d,h,u,1),f=this.meter_to_lat(h),y=this.meter_to_long(d,f),m=this.meter_to_lat(p[1]),g=this.meter_to_long(p[0],m),w=new o.Cartesian3.fromDegrees(y,f,0),b=new o.Cartesian3.fromDegrees(g,m,0),C=new o.Cartesian3(b.x-w.x,b.y-w.y,b.z-w.z);return o.Cartesian3.normalize(C,r)},degree2rad:function(e){return e*Math.PI/180},rad2degree:function(e){return 180*e/Math.PI},computeArea:function(e){let t=e.length;if(t<3)return 0;let i=e[0][1]*(e[t-1][0]-e[1][0]);for(let n=1;n<t;n++)i+=e[n][1]*(e[n-1][0]-e[(n+1)%t][0]);return Math.abs(i/2)},calculationDistance:function(e,t){let i=e.y,n=t.y,o=e.x,r=t.x;return Math.sqrt((r-o)*(r-o)+(n-i)*(n-i))},douglasPeucker:function(e,t,i){if(!(e&&e.length>2))return null;e.forEach(((e,t)=>{e.id=t}));let n=W(e,[],0,e.length-1,t,i);n.push(e[0]),n.push(e[e.length-1]);let o=n.sort(((e,t)=>e.id<t.id?-1:e.id>t.id?1:0));return o.forEach((e=>{e.id=void 0})),o},guid:function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+e()+e()+e()+e()+e()+e()},BLHConvertToXYZ:function(e,t){e=o.Cartesian3.fromDegreesArrayHeights(e),t=o.Cartesian3.fromDegrees(t[0],t[1],t[2]);let i=o.Transforms.eastNorthUpToFixedFrame(t),n=o.Matrix4.inverse(i,new o.Matrix4),r=new Float64Array(3*e.length);for(let t=0;t<e.length;t++){let i=o.Matrix4.multiplyByPoint(n,e[t],new o.Cartesian3);r[3*t+0]=i.x,r[3*t+1]=i.y,r[3*t+2]=i.z}return r},calculationIntersection:function(e,t,i){i[0]?i[1]=e[1]+(i[0]-e[0])*(t[1]-e[1])/(t[0]-e[0]):i[0]=e[0]+(t[0]-e[0])*(i[1]-e[1])/(t[1]-e[1])},calculateTriangle:function(e){let t={x:e[0].x-e[1].x,y:e[0].y-e[1].y,z:e[0].z-e[1].z},i={x:e[1].x-e[2].x,y:e[1].y-e[2].y,z:e[1].z-e[2].z},n={x:e[0].x-e[2].x,y:e[0].y-e[2].y,z:e[0].z-e[2].z},r=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)+Math.pow(t.z,2)),a=Math.sqrt(Math.pow(i.x,2)+Math.pow(i.y,2)+Math.pow(i.z,2)),s=Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2)+Math.pow(n.z,2)),l=Math.acos((r**2+a**2-s**2)/(2*a*s));return o.Math.toDegrees(l)}};function x(e,t,i,n,o){return Math.abs(e-i)<o&&Math.abs(t-n)<o}function O(e){return!(e>180||e<-180)}function A(e){return!(e>90||e<-90)}function R(e,t,i){let n=Math.abs(B.calculationDistance(e,t)),o=Math.abs(B.calculationDistance(e,i)),r=Math.abs(B.calculationDistance(t,i)),a=(n+o+r)/2;return 2*Math.sqrt(Math.abs(a*(a-n)*(a-o)*(a-r)))/n}function W(e,t,i,n,o,r){if(i<n){let a=0,s=e[i],l=e[n];if(Math.abs(s.x-l.x)>r||Math.abs(s.y-l.y)>r){let c=0;for(let t=i+1;t<n;t++){let i=R(s,l,e[t]);i>c&&(c=i,a=t)}c>=o&&(t.push(e[a]),W(e,t,i,a,o,r),W(e,t,a,n,o,r))}else a=Math.floor((i+n)/2),a>i&&a<n&&(t.push(e[a]),W(e,t,i,a,o,r),W(e,t,a,n,o,r))}return t}var N=B;function G(e="cartesian",t,i){"function"==typeof t&&t("cartographicObj"===e?N.cartesianToCartographicObj(i):"cartographicArr"===e?N.cartesianToCartographicArr(i):"cartographicPoiArr"===e?N.cartesianToCartographicPoiArr(i):i)}var F=class{constructor(e){this.viewer=e;let t=new o.CustomDataSource("画图工具-实体集合");this.dataSourceToo=t,e.dataSources.add(t),this.entityFactory=new h(e,t),this.dynamicPosition=null,this.dynamicPoint=null,this.coordinates=[],this.dynamicNodesPoint=[],this.drawEntities=null,this.height=null,this.errCallback=null,this.isDepthTest=null}drawPoint({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){let r=this,{handler:a}=r.drawShapeStart();r.errCallback=n,a.setInputAction((function(i){let n=r.viewer.scene.pickPosition(i.position);o.defined(n)&&(a.isDestroyed()||(a.destroy(),a=null),r.drawShapeEnd(),G(e,t,[n]))}),o.ScreenSpaceEventType.LEFT_CLICK),a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.endPosition);o.defined(t)&&(o.defined(r.dynamicPoint)||(r.dynamicPoint=r.entityFactory.createPoint(t)),r.dynamicPoint.position.setValue(t)),"function"==typeof i&&i(t)}),o.ScreenSpaceEventType.MOUSE_MOVE),a.setInputAction((function(e){a.isDestroyed()||(a.destroy(),a=null),r.drawShapeErrorCallback(),r.drawShapeEnd()}),o.ScreenSpaceEventType.RIGHT_CLICK)}drawLine({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){let r=this,{handler:a}=r.drawShapeStart();r.errCallback=n;let s=[];a.setInputAction((function(i){let n=r.viewer.scene.pickPosition(i.position);o.defined(n)&&(r.dynamicNodesPoint.push(r.entityFactory.createPoint(n)),r.coordinates.push(n),s.push(n),r.drawEntities||(r.drawEntities=r.dataSourceToo.entities.add({polyline:{positions:new o.CallbackProperty((function(){return r.coordinates}),!1),width:3,clampToGround:!0,arcType:o.ArcType.RHUMB,material:o.Color.GREEN}})),2===s.length&&(G(e,t,s),a.isDestroyed()||(a.destroy(),a=null),r.drawShapeEnd()))}),o.ScreenSpaceEventType.LEFT_CLICK),a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.endPosition);o.defined(t)&&(o.defined(r.dynamicPoint)||(r.dynamicPoint=r.entityFactory.createPoint(t)),r.dynamicPoint.position.setValue(t),1===r.coordinates.length&&r.coordinates.push(t),2===r.coordinates.length&&(r.coordinates.pop(),r.coordinates.push(t)),"function"==typeof i&&i(r.coordinates))}),o.ScreenSpaceEventType.MOUSE_MOVE),a.setInputAction((function(e){a.isDestroyed()||(a.destroy(),a=null),r.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}drawPolyLine({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){let r=this,{handler:a}=r.drawShapeStart();r.errCallback=n;let s,l=[];a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.position);o.defined(t)&&(r.dynamicNodesPoint.push(r.entityFactory.createPoint(t)),l.push(t),r.coordinates.push(t),r.drawEntities||(s=new o.CallbackProperty((function(){return r.coordinates}),!1),r.drawEntities=r.dataSourceToo.entities.add({polyline:{positions:s,width:3,clampToGround:!0,arcType:o.ArcType.RHUMB,material:o.Color.GREEN}})))}),o.ScreenSpaceEventType.LEFT_CLICK),a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.endPosition);o.defined(t)&&(o.defined(r.dynamicPoint)||(r.dynamicPoint=r.entityFactory.createPoint(t)),r.dynamicPoint.position.setValue(t),1===r.coordinates.length&&r.coordinates.push(t),r.coordinates.length>=2&&(r.coordinates.pop(),r.coordinates.push(t)),"function"==typeof i&&i(r.coordinates))}),o.ScreenSpaceEventType.MOUSE_MOVE),a.setInputAction((function(i){a.isDestroyed()||(a.destroy(),a=null),r.drawShapeEnd(),l.length>=2?G(e,t,l):r.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}drawTriangle({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){let r=this,{handler:a}=r.drawShapeStart();r.errCallback=n;let s,l=[];a.setInputAction((function(i){let n=r.viewer.scene.pickPosition(i.position);o.defined(n)&&(r.dynamicNodesPoint.push(r.entityFactory.createPoint(n)),l.push(n),r.coordinates.push(n),r.drawEntities||(s=new o.CallbackProperty((function(){return r.coordinates}),!1),r.drawEntities=r.dataSourceToo.entities.add({polyline:{positions:s,width:3,clampToGround:!0,arcType:o.ArcType.RHUMB,material:o.Color.GREEN}})),3===l.length&&(G(e,t,l),a.isDestroyed()||(a.destroy(),a=null),r.drawShapeEnd()))}),o.ScreenSpaceEventType.LEFT_CLICK),a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.endPosition);o.defined(t)&&(o.defined(r.dynamicPoint)||(r.dynamicPoint=r.entityFactory.createPoint(t)),r.dynamicPoint.position.setValue(t),1===r.coordinates.length&&r.coordinates.push(t),r.coordinates.length>=2&&(r.coordinates.pop(),r.coordinates.push(t)),"function"==typeof i&&i(r.coordinates))}),o.ScreenSpaceEventType.MOUSE_MOVE),a.setInputAction((function(i){a.isDestroyed()||(a.destroy(),a=null),r.drawShapeEnd(),l.length>=2?G(e,t,l):r.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}drawPolygon({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){let r=this,{handler:a}=r.drawShapeStart();r.errCallback=n;let s=[];a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.position);o.defined(t)&&(r.dynamicNodesPoint.push(r.entityFactory.createPoint(t)),s.push(JSON.parse(JSON.stringify(t))),r.coordinates.push(t),2===r.dynamicNodesPoint.length&&(r.drawEntities||(r.dynamicPosition=new o.CallbackProperty((function(){return new o.PolygonHierarchy(r.coordinates)}),!1),r.drawEntities=r.dataSourceToo.entities.add({polygon:{hierarchy:r.dynamicPosition,material:new o.ColorMaterialProperty(o.Color.LIGHTSKYBLUE.withAlpha(.3)),heightReference:o.HeightReference.NONE}}))))}),o.ScreenSpaceEventType.LEFT_CLICK),a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.endPosition);if(o.defined(t)&&(o.defined(r.dynamicPoint)||(r.dynamicPoint=r.entityFactory.createPoint(t)),r.dynamicPoint.position.setValue(t),r.coordinates.pop(),r.coordinates.push(t),"function"==typeof i)){let e=JSON.parse(JSON.stringify(s));e.push(JSON.parse(JSON.stringify(t))),i(e)}}),o.ScreenSpaceEventType.MOUSE_MOVE),a.setInputAction((function(){a.isDestroyed()||(a.destroy(),a=null),r.drawShapeEnd(),s.length>=2?(s.push(s[0]),G(e,t,s)):r.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}drwCurve({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){}drawCircle({endCallback:e,moveCallback:t,errCallback:i}){let n,r,a=this,{handler:s}=a.drawShapeStart();a.errCallback=i;let l=0;s.setInputAction((function(t){let i=a.viewer.scene.pickPosition(t.position);o.defined(i)&&(a.dynamicNodesPoint.push(a.entityFactory.createPoint(i)),r?("function"==typeof e&&e({Center:r,EndPoint:i,Radius:l}),s.isDestroyed()||(s.destroy(),s=null),a.drawShapeEnd()):r=i)}),o.ScreenSpaceEventType.LEFT_CLICK),s.setInputAction((function(e){let i=a.viewer.scene.pickPosition(e.endPosition);if(o.defined(i)&&(o.defined(a.dynamicPoint)||(a.dynamicPoint=a.entityFactory.createPoint(i)),a.dynamicPoint.position.setValue(i),r)){let e=a.viewer.scene.globe.ellipsoid.cartesianToCartographic(r),s=a.viewer.scene.globe.ellipsoid.cartesianToCartographic(i),c=new o.EllipsoidGeodesic(e,s);l=c.surfaceDistance,"function"==typeof t&&t({Center:r,EndPoint:i,Radius:l}),n||(n=new o.CallbackProperty((function(){return l}),!1)),a.drawEntities||(a.drawEntities=a.dataSourceToo.entities.add({position:r,name:"Red ellipse on surface",ellipse:{semiMinorAxis:n,semiMajorAxis:n,material:o.Color.RED.withAlpha(.5)}}))}}),o.ScreenSpaceEventType.MOUSE_MOVE),s.setInputAction((function(e){s.isDestroyed()||(s.destroy(),s=null),a.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}drawRectangle({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){let r=this,{handler:a}=r.drawShapeStart();r.errCallback=n;let s,l=[],c=[];a.setInputAction((function(i){let n=r.viewer.scene.pickPosition(i.position);o.defined(n)&&(r.dynamicNodesPoint.push(r.entityFactory.createPoint(n)),l.push(n),1===l.length&&(r.drawEntities||(s=new o.CallbackProperty((function(){return new o.PolygonHierarchy(c)}),!1),r.drawEntities=r.dataSourceToo.entities.add({polygon:{hierarchy:s,material:new o.ColorMaterialProperty(o.Color.LIGHTSKYBLUE.withAlpha(.3)),heightReference:o.HeightReference.NONE}}))),2===l.length&&(l[1]=n,c=r.getRectanglePoint(r.viewer,l[0],l[1]),G(e,t,c),a.isDestroyed()||(a.destroy(),a=null),r.drawShapeEnd()))}),o.ScreenSpaceEventType.LEFT_CLICK),a.setInputAction((function(e){let t=r.viewer.scene.pickPosition(e.endPosition);o.defined(t)&&(o.defined(r.dynamicPoint)||(r.dynamicPoint=r.entityFactory.createPoint(t)),r.dynamicPoint.position.setValue(t)),1===l.length&&t&&(c=c=r.getRectanglePoint(r.viewer,l[0],t),"function"==typeof i&&i(r.coordinates))}),o.ScreenSpaceEventType.MOUSE_MOVE),a.setInputAction((function(){a.isDestroyed()||(a.destroy(),a=null),r.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}drawInclinedRectangle({coordinateType:e,endCallback:t,moveCallback:i,errCallback:n}){let r,a=this,{handler:s}=a.drawShapeStart();a.errCallback=n,s.setInputAction((function(i){let n=a.viewer.scene.pickPosition(i.position);o.defined(n)&&(a.dynamicNodesPoint.push(a.entityFactory.createPoint(n)),a.coordinates.length<2&&a.coordinates.push(n),2===a.dynamicNodesPoint.length&&(a.drawEntities||(r=new o.CallbackProperty((function(){return new o.PolygonHierarchy(a.coordinates)}),!1),a.drawEntities=a.dataSourceToo.entities.add({polygon:{hierarchy:r,material:new o.ColorMaterialProperty(o.Color.LIGHTSKYBLUE.withAlpha(.3)),heightReference:o.HeightReference.NONE}}))),3===a.dynamicNodesPoint.length&&(G(e,t,a.coordinates),s.isDestroyed()||(s.destroy(),s=null),a.drawShapeEnd()))}),o.ScreenSpaceEventType.LEFT_CLICK),s.setInputAction((function(e){let t=a.viewer.scene.pickPosition(e.endPosition);if(o.defined(t)&&(o.defined(a.dynamicPoint)||(a.dynamicPoint=a.entityFactory.createPoint(t)),a.dynamicPoint.position.setValue(t)),2===a.coordinates.length){let e=new o.Cartesian3,i=new o.Cartesian3;a.getInclinedRectangle(a.coordinates[0],a.coordinates[1],t,e,i),a.coordinates.push(e,i)}else if(a.coordinates.length>2){a.coordinates.pop(),a.coordinates.pop();let e=new o.Cartesian3,n=new o.Cartesian3;a.getInclinedRectangle(a.coordinates[0],a.coordinates[1],t,e,n),a.coordinates.push(e),a.coordinates.push(n),"function"==typeof i&&i(a.coordinates)}}),o.ScreenSpaceEventType.MOUSE_MOVE),s.setInputAction((function(){s.isDestroyed()||(s.destroy(),s=null),a.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}startDrawingeYPlan({position:e,normal:t,dimensions:i,endCallback:n,moveCallback:r,errCallback:a}){let s=this,{handler:l}=s.drawShapeStart();var c;s.errCallback=a;var d=0,h=new o.ClippingPlane(t,0);s.drawEntities=s.dataSourceToo.entities.add({position:e,plane:{dimensions:i,material:o.Color.BLUE.withAlpha(.5),plane:new o.CallbackProperty(function(e){return function(){return e.distance=d,e}}(h),!1),outline:!0,outlineColor:o.Color.BLUE}}),s.drawEntities.startDrawingeYPlan="startDrawingeYPlan",l.setInputAction((function(e){var t=s.viewer.scene.pick(e.position);o.defined(t)&&o.defined(t.id)&&o.defined(t.id.plane)&&"startDrawingeYPlan"==t.id.startDrawingeYPlan&&((c=t.id.plane).material=o.Color.RED.withAlpha(.5),c.outlineColor=o.Color.RED,s.viewer.scene.screenSpaceCameraController.enableInputs=!1)}),o.ScreenSpaceEventType.LEFT_DOWN),l.setInputAction((function(){o.defined(c)&&(c.material=o.Color.BLUE.withAlpha(.5),c.outlineColor=o.Color.BLUE,c=void 0),"function"==typeof n&&n(d),s.viewer.scene.screenSpaceCameraController.enableInputs=!0}),o.ScreenSpaceEventType.LEFT_UP),l.setInputAction((function(e){if(o.defined(c)){var t=e.startPosition.y-e.endPosition.y;d+=t}}),o.ScreenSpaceEventType.MOUSE_MOVE),l.setInputAction((function(e){l.isDestroyed()||(l.destroy(),l=null),s.drawShapeErrorCallback()}),o.ScreenSpaceEventType.RIGHT_CLICK)}getInclinedRectangle(e,t,i,n,r){let a=o.Cartographic.fromCartesian(e),s=o.Cartographic.fromCartesian(t),l=o.Cartographic.fromCartesian(i),c=(a.longitude+s.longitude)/2,d=(a.latitude+s.latitude)/2,h=N.lon_to_meter(a.longitude-c,a.latitude),u=N.lat_to_meter(a.latitude-d),p=N.lon_to_meter(s.longitude-c,s.latitude),f=N.lat_to_meter(s.latitude-d),y=N.lon_to_meter(l.longitude-c,l.latitude),m=N.lat_to_meter(l.latitude-d),g=[];N.pointProjectLine(y,m,h,u,p,f,g);let w=N.TwoPointsDistance(y,m,g[0],g[1]),b=N.vecAngle(g[0],g[1],y,m),C=N.polarPoint(h,u,b,w),v=N.polarPoint(p,f,b,w),S=N.meter_to_lat(C[1])+d,P=N.meter_to_long(C[0],S)+c,E=N.meter_to_lat(v[1])+d,T=N.meter_to_long(v[0],E)+c;a.longitude=P,a.latitude=S,s.longitude=T,s.latitude=E,o.Cartographic.toCartesian(a,o.Ellipsoid.WGS84,r),o.Cartographic.toCartesian(s,o.Ellipsoid.WGS84,n)}getRectanglePoint(e,t){let i=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e),n=o.Math.toDegrees(i.longitude),r=o.Math.toDegrees(i.latitude),a=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(t),s=o.Math.toDegrees(a.longitude),l=o.Math.toDegrees(a.latitude),c=Math.min(n,s),d=Math.max(n,s),h=Math.min(r,l),u=Math.max(r,l),p=o.Cartesian3.fromDegrees(c,u);return[p,o.Cartesian3.fromDegrees(d,u),o.Cartesian3.fromDegrees(d,h),o.Cartesian3.fromDegrees(c,h),p]}drawShapeErrorCallback(){let e=this;e.clearDrawEntity(),e.errCallback&&"function"==typeof e.errCallback&&(e.errCallback(),e.errCallback=null)}drawShapeStart(){let e=this,t=_.getHandle(e.viewer,e.drawShapeErrorCallback).handler;return e.isDepthTest=e.viewer.scene.globe.depthTestAgainstTerrain,e.isDepthTest||(e.viewer.scene.globe.depthTestAgainstTerrain=!0,console.log("%c自动开启深度检测！","color: #43bb88;")),{handler:t}}drawShapeEnd(){let e=this;e.clearDrawEntity(),e.viewer.scene.globe.depthTestAgainstTerrain=e.isDepthTest,e.isDepthTest||(e.viewer.scene.globe.depthTestAgainstTerrain=!1,console.log("%c自动关闭深度检测！","color: rgb(200,20,20);"))}clearDrawEntity(){let e=this;e.dynamicPosition=null,e.dynamicPoint&&e.dataSourceToo.entities.remove(e.dynamicPoint),e.dynamicPoint=null,e.coordinates=[];for(let t=0;t<e.dynamicNodesPoint.length;t++)e.dynamicNodesPoint[t]&&e.dataSourceToo.entities.remove(e.dynamicNodesPoint[t]);e.dynamicNodesPoint=[],e.drawEntities&&e.dataSourceToo.entities.remove(e.drawEntities),e.drawEntities=null}};let K={contents:[o.Rectangle.fromDegrees(113.537926,36.066539,119.848199,42.656242),o.Rectangle.fromDegrees(116.784339,39.929257,117.109741,40.043802)],startFlyCallbacks:[],endFlyCallbacks:[],start(e){let t=i.viewerLeft;e&&(this.contents=[o.Rectangle.fromDegrees(e[0][0],e[0][1],e[0][2],e[0][3]),o.Rectangle.fromDegrees(e[1][0],e[1][1],e[1][2],e[1][3])]),K.startFlyCallbacks.forEach((e=>{e()})),t.camera.flyTo({destination:this.contents[0],duration:2,complete:function(){t.camera.flyTo({destination:this.contents[1],complete:function(){K.endFlyCallbacks.forEach((e=>{e()}))}})}})},onStartFly(e){"function"==typeof e&&this.startFlyCallbacks.push(e)},onEndFly(e){"function"==typeof e&&this.endFlyCallbacks.push(e)}};var V=K;let H,z,U,J;function q(e){let t=e.camera.positionCartographic.height,i=Date.now(),n=(i-z)/1e3*5/180*Math.PI*(t/24678990.67414785);z=i,e.scene.camera.rotate(o.Cartesian3.UNIT_Z,-n)}function Z(e){(new Date).getTime()-H.getTime()>6e4&&function(e){z=Date.now(),e.clock.onTick.addEventListener(q),window.clearInterval(U),U=null}(e)}var j={rotateInit(e){let t=this;J=new o.ScreenSpaceEventHandler(e.scene.canvas),J.setInputAction((function(){t.endRote(e)}),o.ScreenSpaceEventType.MOUSE_MOVE)},endRote(e){e.clock.onTick.removeEventListener(q),U||(U=window.setInterval(Z,500)),H=new Date}};function Q(){}Q.WKBByteOrder={},Q.WKBByteOrder.wkbXDR=0,Q.WKBByteOrder.wkbNDR=1,Q.WKBGeometryType={},Q.WKBGeometryType.wkbPoint=1,Q.WKBGeometryType.wkbLineString=2,Q.WKBGeometryType.wkbPolygon=3,Q.WKBGeometryType.wkbTriangle=17,Q.WKBGeometryType.wkbMultiPoint=4,Q.WKBGeometryType.wkbMultiLineString=5,Q.WKBGeometryType.wkbMultiPolygon=6,Q.WKBGeometryType.wkbGeometryCollection=7,Q.WKBGeometryType.wkbPolyhedralSurface=15,Q.WKBGeometryType.wkbTIN=16,Q.WKBGeometryType.wkbPointZ=1001,Q.WKBGeometryType.wkbLineStringZ=1002,Q.WKBGeometryType.wkbPolygonZ=1003,Q.WKBGeometryType.wkbTrianglez=1017,Q.WKBGeometryType.wkbMultiPointZ=1004,Q.WKBGeometryType.wkbMultiLineStringZ=1005,Q.WKBGeometryType.wkbMultiPolygonZ=1006,Q.WKBGeometryType.wkbGeometryCollectionZ=1007,Q.WKBGeometryType.wkbPolyhedralSurfaceZ=1015,Q.WKBGeometryType.wkbTINZ=1016,Q.WKBGeometryType.wkbPointM=2001,Q.WKBGeometryType.wkbLineStringM=2002,Q.WKBGeometryType.wkbPolygonM=2003,Q.WKBGeometryType.wkbTriangleM=2017,Q.WKBGeometryType.wkbMultiPointM=2004,Q.WKBGeometryType.wkbMultiLineStringM=2005,Q.WKBGeometryType.wkbMultiPolygonM=2006,Q.WKBGeometryType.wkbGeometryCollectionM=2007,Q.WKBGeometryType.wkbPolyhedralSurfaceM=2015,Q.WKBGeometryType.wkbTINM=2016,Q.WKBGeometryType.wkbPointZM=3001,Q.WKBGeometryType.wkbLineStringZM=3002,Q.WKBGeometryType.wkbPolygonZM=3003,Q.WKBGeometryType.wkbTriangleZM=3017,Q.WKBGeometryType.wkbMultiPointZM=3004,Q.WKBGeometryType.wkbMultiLineStringZM=3005,Q.WKBGeometryType.wkbMultiPolygonZM=3006,Q.WKBGeometryType.wkbGeometryCollectionZM=3007,Q.WKBGeometryType.wkbPolyhedralSurfaceZM=3015,Q.WKBGeometryType.wkbTinZM=3016;function Y(e){let t,i;return Q.WKBByteOrder.wkbNDR==e.byteOrder?(t=e.buffer.readDoubleLE(e.offset),e.offset+=8,i=e.buffer.readDoubleLE(e.offset),e.offset+=8):(t=e.buffer.readDoubleBE(e.offset),e.offset+=8,i=e.buffer.readDoubleBE(e.offset),e.offset+=8),new Q.Point(t,i)}function X(e){let t,i,n;return Q.WKBByteOrder.wkbNDR==e.byteOrder?(t=e.buffer.readDoubleLE(e.offset),e.offset+=8,i=e.buffer.readDoubleLE(e.offset),e.offset+=8,n=e.buffer.readDoubleLE(e.offset),e.offset+=8):(t=e.buffer.readDoubleBE(e.offset),e.offset+=8,i=e.buffer.readDoubleBE(e.offset),e.offset+=8,n=e.buffer.readDoubleBE(e.offset),e.offset+=8),new Q.PointZ(t,i,n)}function ee(e){let t,i,n;return Q.WKBByteOrder.wkbNDR==e.byteOrder?(t=e.buffer.readDoubleLE(e.offset),e.offset+=8,i=e.buffer.readDoubleLE(e.offset),e.offset+=8,n=e.buffer.readDoubleLE(e.offset),e.offset+=8):(t=e.buffer.readDoubleBE(e.offset),e.offset+=8,i=e.buffer.readDoubleBE(e.offset),e.offset+=8,n=e.buffer.readDoubleBE(e.offset),e.offset+=8),new Q.PointM(t,i,n)}function te(e){let t,i,n,o;return Q.WKBByteOrder.wkbNDR==e.byteOrder?(t=e.buffer.readDoubleLE(e.offset),e.offset+=8,i=e.buffer.readDoubleLE(e.offset),e.offset+=8,n=e.buffer.readDoubleLE(e.offset),e.offset+=8,o=e.buffer.readDoubleLE(e.offset),e.offset+=8):(t=e.buffer.readDoubleBE(e.offset),e.offset+=8,i=e.buffer.readDoubleBE(e.offset),e.offset+=8,n=e.buffer.readDoubleBE(e.offset),e.offset+=8,o=e.buffer.readDoubleBE(e.offset),e.offset+=8),new Q.PointZM(t,i,n,o)}function ie(e){let t,i=e.buffer,n=null,o=i[e.offset];if(e.offset++,Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4),t==Q.WKBGeometryType.wkbLineString){let t;Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4);let r=[];for(let i=0;i<t;i++)r.push(Y(e));n=new Q.LinearRing(t,r)}return n}function ne(e){let t,i=e.buffer,n=null,o=i[e.offset];if(e.offset++,Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4),t==Q.WKBGeometryType.wkbLineStringZ){let t;Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4);let r=[];for(let i=0;i<t;i++)r.push(X(e));n=new Q.LinearRingZ(t,r)}return n}function oe(e){let t,i=e.buffer,n=null,o=i[e.offset];if(e.offset++,Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4),t==Q.WKBGeometryType.wkbLineStringM){let t;Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4);let r=[];for(let i=0;i<t;i++)r.push(ee(e));n=new Q.LinearRingM(t,r)}return n}function re(e){let t,i=e.buffer,n=null,o=i[e.offset];if(e.offset++,Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4),t==Q.WKBGeometryType.wkbLineStringZM){let t;Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4);let r=[];for(let i=0;i<t;i++)r.push(te(e));n=new Q.LinearRingZM(t,r)}return n}function ae(e){let t,i=e.buffer,n=null,o=i[e.offset];if(e.offset++,Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4),t==Q.WKBGeometryType.wkbPolygon){let r;Q.WKBByteOrder.wkbNDR==o?(r=i.readInt32LE(e.offset),e.offset+=4):(r=i.readInt32BE(e.offset),e.offset+=4);let a=[];for(let t=0;t<r;t++){let t;Q.WKBByteOrder.wkbNDR==o?(t=i.readInt32LE(e.offset),e.offset+=4):(t=i.readInt32BE(e.offset),e.offset+=4);let n=[];for(let r=0;r<t;r++){let t,r;Q.WKBByteOrder.wkbNDR==o?(t=i.readDoubleLE(e.offset),e.offset+=8,r=i.readDoubleLE(e.offset),e.offset+=8):(t=i.readDoubleBE(e.offset),e.offset+=8,r=i.readDoubleBE(e.offset),e.offset+=8);let a=new Q.Point(t,r);n.push(a)}let r=new Q.LinearRing(t,n);a.push(r)}n=new Q.WKBPolygon(o,t,r,a)}return n}function se(){}function le(){}function ce(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}Q.fromBase64=function(e){let t=new Q,i=function(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace("-","+").replace("_","/"),i=window.atob(t),n=new Uint8Array(i.length);for(let e=0;e<i.length;++e)n[e]=i.charCodeAt(e);return n}(e);switch(t.buffer=function(e){if(e.length>2147483647)throw new RangeError('The value "'+length+'" is invalid for option "size"');var t=e;for(let e in le.prototype)t.__proto__[e]||(t.__proto__[e]=le.prototype[e]);return t}(i),t.length=i.length,t.offset=0,t.byteOrder=i[t.offset],t.offset++,Q.WKBByteOrder.wkbNDR==t.byteOrder?(t.wkbType=t.buffer.readInt32LE(t.offset),t.offset+=4):(t.wkbType=t.buffer.readInt32BE(t.offset),t.offset+=4),t.wkbType){case Q.WKBGeometryType.wkbPoint:t.geom=Y(t);break;case Q.WKBGeometryType.wkbPointZ:t.geom=X(t);break;case Q.WKBGeometryType.wkbPointM:t.geom=ee(t);break;case Q.WKBGeometryType.wkbPointZM:t.geom=te(t);break;case Q.WKBGeometryType.wkbLineString:case Q.WKBGeometryType.wkbLineStringZ:case Q.WKBGeometryType.wkbLineStringM:case Q.WKBGeometryType.wkbLineStringZM:t.geom=ie(t);break;case Q.WKBGeometryType.wkbMultiLineString:Q.WKBByteOrder.wkbNDR==t.byteOrder?(o=t.buffer.readInt32LE(t.offset),t.offset+=4):(o=t.buffer.readInt32BE(t.offset),t.offset+=4);var n=[];for(let e=0;e<o;e++)n.push(ie(t));t.geom=new Q.WKBMultiLineString(t.byteOrder,Q.WKBGeometryType.wkbMultiLineString,o,n);break;case Q.WKBGeometryType.wkbMultiLineStringZ:Q.WKBByteOrder.wkbNDR==t.byteOrder?(o=t.buffer.readInt32LE(t.offset),t.offset+=4):(o=t.buffer.readInt32BE(t.offset),t.offset+=4),n=[];for(let e=0;e<o;e++)n.push(ne(t));t.geom=new Q.WKBMultiLineStringZ(t.byteOrder,Q.WKBGeometryType.wkbMultiLineStringZ,o,n);break;case Q.WKBGeometryType.wkbMultiLineStringM:Q.WKBByteOrder.wkbNDR==t.byteOrder?(o=t.buffer.readInt32LE(t.offset),t.offset+=4):(o=t.buffer.readInt32BE(t.offset),t.offset+=4),n=[];for(let e=0;e<o;e++)n.push(oe(t));t.geom=new Q.WKBMultiLineStringM(t.byteOrder,Q.WKBGeometryType.wkbMultiLineStringM,o,n);break;case Q.WKBGeometryType.wkbMultiLineStringZM:var o;Q.WKBByteOrder.wkbNDR==t.byteOrder?(o=t.buffer.readInt32LE(t.offset),t.offset+=4):(o=t.buffer.readInt32BE(t.offset),t.offset+=4),n=[];for(let e=0;e<o;e++)n.push(re(t));t.geom=new Q.WKBMultiLineStringZM(t.byteOrder,Q.WKBGeometryType.wkbMultiLineStringZM,o,n);break;case Q.WKBGeometryType.wkbPolygon:let e;Q.WKBByteOrder.wkbNDR==t.byteOrder?(e=t.buffer.readInt32LE(t.offset),t.offset+=4):(e=t.buffer.readInt32BE(t.offset),t.offset+=4);let i=[];for(let n=0;n<e;n++){let e;Q.WKBByteOrder.wkbNDR==t.byteOrder?(e=t.buffer.readInt32LE(t.offset),t.offset+=4):(e=t.buffer.readInt32BE(t.offset),t.offset+=4);let n=[];for(let i=0;i<e;i++)n.push(Y(t));let o=new Q.LinearRing(e,n);i.push(o)}let r=new Q.WKBPolygon(t.byteOrder,t.wkbType,e,i);t.geom=r;break;case Q.WKBGeometryType.wkbMultiPolygon:let a;Q.WKBByteOrder.wkbNDR==t.byteOrder?(a=t.buffer.readInt32LE(t.offset),t.offset+=4):(a=t.buffer.readInt32BE(t.offset),t.offset+=4);let s=[];for(let e=0;e<a;e++)s.push(ae(t));t.geom=new Q.WKBMultiPolygon(t.byteOrder,Q.WKBGeometryType.wkbMultiPolygon,a,s);break;default:console.log("暂时不支持的wkb数据类型；"+t.wkbType)}return t},Q.Point=function(e,t){this.x=e,this.y=t},Q.PointZ=function(e,t,i){this.x=e,this.y=t,this.z=i},Q.PointM=function(e,t,i){this.x=e,this.y=t,this.m=i},Q.PointZM=function(e,t,i,n){this.x=e,this.y=t,this.z=i,this.m=n},Q.LinearRing=function(e,t){this.numPoints=e,this.points=t},Q.LinearRingZ=function(e,t){this.numPoints=e,this.points=t},Q.LinearRingM=function(e,t){this.numPoints=e,this.points=t},Q.LinearRingZM=function(e,t){this.numPoints=e,this.points=t},Q.WKBMultiLineString=function(e,t,i,n){this.byteOrder=e,this.wkbType=t,this.numLineStrings=i,this.lineStrings=n},Q.WKBMultiLineStringZ=function(e,t,i,n){this.byteOrder=e,this.wkbType=t,this.numLineStrings=i,this.lineStrings=n},Q.WKBMultiLineStringM=function(e,t,i,n){this.byteOrder=e,this.wkbType=t,this.numLineStrings=i,this.lineStrings=n},Q.WKBMultiLineStringZM=function(e,t,i,n){this.byteOrder=e,this.wkbType=t,this.numLineStrings=i,this.lineStrings=n},Q.WKBPolygon=function(e,t,i,n){this.byteOrder=e,this.wkbType=t,this.numRings=i,this.rings=n},Q.WKBMultiPolygon=function(e,t,i,n){this.byteOrder=e,this.wkbType=t,this.numPolygons=i,this.polygons=n},se.read=function(e,t,i,n,o){var r,a,s=8*o-n-1,l=(1<<s)-1,c=l>>1,d=-7,h=i?o-1:0,u=i?-1:1,p=e[t+h];for(h+=u,r=p&(1<<-d)-1,p>>=-d,d+=s;d>0;r=256*r+e[t+h],h+=u,d-=8);for(a=r&(1<<-d)-1,r>>=-d,d+=n;d>0;a=256*a+e[t+h],h+=u,d-=8);if(0===r)r=1-c;else{if(r===l)return a?NaN:1/0*(p?-1:1);a+=Math.pow(2,n),r-=c}return(p?-1:1)*a*Math.pow(2,r-n)},se.write=function(e,t,i,n,o,r){var a,s,l,c=8*r-o-1,d=(1<<c)-1,h=d>>1,u=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:r-1,f=n?1:-1,y=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,a=d):(a=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-a))<1&&(a--,l*=2),(t+=a+h>=1?u/l:u*Math.pow(2,1-h))*l>=2&&(a++,l/=2),a+h>=d?(s=0,a=d):a+h>=1?(s=(t*l-1)*Math.pow(2,o),a+=h):(s=t*Math.pow(2,h-1)*Math.pow(2,o),a=0));o>=8;e[i+p]=255&s,p+=f,s/=256,o-=8);for(a=a<<o|s,c+=o;c>0;e[i+p]=255&a,p+=f,a/=256,c-=8);e[i+p-f]|=128*y},le.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||ce(e,t,this.length);for(var n=this[e],o=1,r=0;++r<t&&(o*=256);)n+=this[e+r]*o;return n},le.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||ce(e,t,this.length);for(var n=this[e+--t],o=1;t>0&&(o*=256);)n+=this[e+--t]*o;return n},le.prototype.readUInt8=function(e,t){return e>>>=0,t||ce(e,1,this.length),this[e]},le.prototype.readUInt16LE=function(e,t){return e>>>=0,t||ce(e,2,this.length),this[e]|this[e+1]<<8},le.prototype.readUInt16BE=function(e,t){return e>>>=0,t||ce(e,2,this.length),this[e]<<8|this[e+1]},le.prototype.readUInt32LE=function(e,t){return e>>>=0,t||ce(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},le.prototype.readUInt32BE=function(e,t){return e>>>=0,t||ce(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},le.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||ce(e,t,this.length);for(var n=this[e],o=1,r=0;++r<t&&(o*=256);)n+=this[e+r]*o;return n>=(o*=128)&&(n-=Math.pow(2,8*t)),n},le.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||ce(e,t,this.length);for(var n=t,o=1,r=this[e+--n];n>0&&(o*=256);)r+=this[e+--n]*o;return r>=(o*=128)&&(r-=Math.pow(2,8*t)),r},le.prototype.readInt8=function(e,t){return e>>>=0,t||ce(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},le.prototype.readInt16LE=function(e,t){e>>>=0,t||ce(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},le.prototype.readInt16BE=function(e,t){e>>>=0,t||ce(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},le.prototype.readInt32LE=function(e,t){return e>>>=0,t||ce(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},le.prototype.readInt32BE=function(e,t){return e>>>=0,t||ce(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},le.prototype.readFloatLE=function(e,t){return e>>>=0,t||ce(e,4,this.length),se.read(this,e,!0,23,4)},le.prototype.readFloatBE=function(e,t){return e>>>=0,t||ce(e,4,this.length),se.read(this,e,!1,23,4)},le.prototype.readDoubleLE=function(e,t){return e>>>=0,t||ce(e,8,this.length),se.read(this,e,!0,52,8)},le.prototype.readDoubleBE=function(e,t){return e>>>=0,t||ce(e,8,this.length),se.read(this,e,!1,52,8)};var de=Q;let he={getTreeNodes:function(){let e=[],t=VGEEarth.getConfig(),i=[...t.layerList,...t.terrainList,...t.modelList,...t.cesium3DTileSetList,...t.geoJsonList,...t.poi],n=VGEEarth.globeDataCache.viewerLeftWorkSpace.nodes,o=function(e){let t=new Map;return e.forEach((e=>{let i=t.get(e.catalog);i?i.push(e):t.set(e.catalog,[e])})),t}(i);for(const[t,i]of o){let o=!0,r={name:t,open:!0,children:[]};i.forEach((e=>{let t=n.find((t=>t.pid===e.pid));r.children.push({id:e.pid,name:e.name,checked:!!t,nodeData:e}),0==!!t&&(o=!1)})),r.checked=o,e.push(r)}return e},getSetting:function(){let e=VGEEarth.globeDataCache.viewerLeftWorkSpace;return{check:{enable:!0,chkboxType:{Y:"ps",N:"ps"}},callback:{onCheck:function(t,i,n){let o=n.checked,r=this.getZTreeObj("treeDom").transformToArray(n);o?r.forEach((t=>{t.children||e.addData(t.nodeData)})):r.forEach((t=>{t.children||e.removeData(t.nodeData)}))},onClick:function(t,i,n){n.children||e.flyToData(n.nodeData)}},data:{simpleData:{enable:!0}}}},initTree:function(){let e=this,t=VGEEarth.globeDataCache.viewerLeftWorkSpace;t?(t.sourceEvent.addEventListener(f,(function(){setTimeout((()=>e.buildTree()),50)}),""),t.sourceEvent.addEventListener(y,(function(){setTimeout((()=>e.buildTree()),50)}),""),this.buildTree()):console.log("请先初始化 Viewer")},buildTree:function(){let e=$("#treeDom"),t=this.getSetting(),i=this.getTreeNodes();$.fn.zTree.init(e,t,i)}};var ue=he;let pe,fe,ye,me,ge,we=new Cesium.Cartesian3,be=new Cesium.Quaternion;function Ce(e){pe=e,pe.scene.preUpdate.addEventListener((function(e,t){null!=fe&&fe.flyActionMana.updateCurrentActionIndex()}))}function ve(e){this.flyActions=e,this.currentActionIndex=0,this.flyActions[0].updatePositionProperty(),this.flyActions[0].uptateOrientationProperty()}function Se(e,t){this.startPosition=t.startPosition,this.currentPosition=this.startPosition,this.endPosition=t.endPosition,this.speed=t.speed,this.type=e,this.position=t.position,this.startQuaternion=t.startQuaternion,this.currentQuaternion=this.startQuaternion,this.endQuaternion=t.endQuaternion,this.rotateSpeed=t.rotateSpeed}function Pe(e){this.times=[],this.quaternions=[]}function Ee(e){return new o.Entity({position:e,point:{pixelSize:5,color:o.Color.RED,outlineColor:o.Color.WHITE,outlineWidth:2}})}Cesium.JulianDate.fromDate(new Date),Ce.startFly=function(e){let t=[],i=[];for(let t=0;t<e.position.length;t+=3)i.push(e.position[t+0]),i.push(e.position[t+1]),i.push(e.position[t+2]+e.height);let n,o,r=Cesium.Cartesian3.fromDegreesArrayHeights(i),a=function(e){let t=new Cesium.SampledPositionProperty,i=Cesium.JulianDate.fromDate(new Date);for(let n=0;n<e.length;n++)t.addSample(Cesium.JulianDate.addSeconds(i,n,new Cesium.JulianDate),e[n]);let n=new Cesium.VelocityOrientationProperty(t),o=[];for(let t=0;t<e.length-1;t++){let e=n.getValue(Cesium.JulianDate.addSeconds(i,t+.5,new Cesium.JulianDate));o.push(e)}return o}(r);for(let i=0;i<r.length;i++){if(0===i){n=r[0];continue}o=r[i];let s=new Se(Se.Type.line,{startPosition:n,endPosition:o,speed:e.speed});if(t.push(s),s.orientations=a,i<r.length-1){let e=new Se(Se.Type.rotate,{position:o,startQuaternion:a[i-1],endQuaternion:a[i],rotateSpeed:10});t.push(e)}n=o}let s=new ve(t);fe=Ce.initEntity(pe,s),fe.flyActionMana=s,ye=Ce.drawEntityLine(pe,e.position),pe.trackedEntity=fe},Ce.hidePlane=function(){1===fe._model._color._value.alpha?(fe._model._color._value.alpha=0,$("#hidePlane").hide(),$("#showPlane").show()):(fe._model._color._value.alpha=1,$("#showPlane").hide(),$("#hidePlane").show())},Ce.hideLine=function(){let e=ye.show;void 0===e||!0===e?(ye.show=!1,$("#hidePath").hide(),$("#showPath").show()):(ye.show=!0,$("#showPath").hide(),$("#hidePath").show())},Ce.quitFly=function(){pe.scene.preUpdate.removeEventListener(Ce.cameraFollow),ye&&(pe.entities.remove(ye),ye=null),fe&&(pe.entities.remove(fe),fe=null)},Ce.pauseFly=function(){let e=fe.flyActionMana,t=e.flyActions[e.currentActionIndex];t.stopPosition(),t.stopOrientation()},Ce.continueFly=function(){let e=fe.flyActionMana,t=e.flyActions[e.currentActionIndex];t.restartPosition(),t.restartOrientation()},Ce.upSpeed=function(){let e=fe.flyActionMana,t=e.flyActions[0].speed;t+=10,t>100&&(t=100),e.updateSpeed(t)},Ce.downSpeed=function(){let e=fe.flyActionMana,t=e.flyActions[0].speed;t-=10,t<15&&(t=10),e.updateSpeed(t)},Ce.follow=function(){pe.trackedEntity=fe},Ce.cameraUpdate=function(){pe.scene.preUpdate.addEventListener(Ce.cameraFollow)},Ce.cameraFollow=function(e,t){let i=new Cesium.HeadingPitchRoll;i=Cesium.HeadingPitchRoll.fromQuaternion(be),pe.camera.setView({destination:we,orientation:{heading:i.heading,pitch:-1,roll:0}}),pe.camera.moveForward(3),pe.camera.moveDown(1)},Ce.free=function(){pe.scene.preUpdate.removeEventListener(Ce.cameraFollow),pe.trackedEntity=void 0},Ce.drawEntityLine=function(e,t){let i=new Cesium.CallbackProperty((function(){return Cesium.Cartesian3.fromDegreesArrayHeights(this.positions)}));i.positions=t;let n=pe.entities.add({polyline:{positions:i,width:5,clampToGround:!0,arcType:Cesium.ArcType.RHUMB,material:Cesium.Color.YELLOW}});return n.positionsProperty=i,n},Ce.initEntity=function(e,t){return me=new Cesium.CallbackProperty((function(){let e=this.flyActionMana.flyActions[this.flyActionMana.currentActionIndex];return we=e.getPosition(Cesium.JulianDate.fromDate(new Date)),e.getPosition(Cesium.JulianDate.fromDate(new Date))}),!1),me.flyActionMana=t,ge=new Cesium.CallbackProperty((function(){let e=this.flyActionMana.flyActions[this.flyActionMana.currentActionIndex];return be=e.getOrientation(Cesium.JulianDate.fromDate(new Date)),e.getOrientation(Cesium.JulianDate.fromDate(new Date))}),!1),ge.flyActionMana=t,e.entities.add({position:me,orientation:ge,model:{uri:"../static/Models/Cesium_Air.glb",scale:1,color:Cesium.Color.fromAlpha(Cesium.Color.WHITE,1),minimumPixelSize:64,maximumScale:1e4,show:!0}})},ve.prototype.updateCurrentActionIndex=function(){let e=this.flyActions[this.currentActionIndex];e.isDestroy()&&(e.resetPosition(),e.resetOrientation(),this.currentActionIndex+1===this.flyActions.length?(this.currentActionIndex=0,this.flyActions[0].updatePositionProperty(),this.flyActions[0].uptateOrientationProperty()):(e=this.flyActions[this.currentActionIndex+1],e.updatePositionProperty(),e.uptateOrientationProperty(),this.currentActionIndex++))},ve.prototype.updateSpeed=function(e){for(let t=0;t<this.flyActions.length;t++)this.flyActions[t].type===Se.Type.line&&(this.flyActions[t].speed=e);let t=this.flyActions[this.currentActionIndex];t.updatePositionProperty(),t.uptateOrientationProperty()},Se.Type={},Se.Type.line=1,Se.Type.rotate=2,Se.prototype.getPosition=function(e){let t;return 1===this.state?t=this.currentPosition:(t=this.positionProperty.getValue(e),this.currentPosition=t,void 0===this.currentPosition&&(this.currentPosition=this.endPosition)),t},Se.prototype.stopPosition=function(){this.state=1},Se.prototype.restartPosition=function(){this.state=0,this.updatePositionProperty()},Se.prototype.resetPosition=function(){this.currentPosition=this.startPosition},Se.prototype.updatePositionProperty=function(){let e=new Cesium.SampledPositionProperty;if(this.type===Se.Type.line){let t=Cesium.JulianDate.fromDate(new Date);e.addSample(t,this.currentPosition);let i=Math.sqrt(Math.pow(this.currentPosition.x-this.endPosition.x,2)+Math.pow(this.currentPosition.y-this.endPosition.y,2)+Math.pow(this.currentPosition.z-this.endPosition.z,2)),n=Cesium.JulianDate.addSeconds(t,i/this.speed,new Cesium.JulianDate);e.addSample(n,this.endPosition)}if(this.type===Se.Type.rotate){let t=Cesium.JulianDate.fromDate(new Date);e.addSample(t,this.position);let i=Cesium.HeadingPitchRoll.fromQuaternion(this.currentQuaternion),n=Cesium.HeadingPitchRoll.fromQuaternion(this.endQuaternion),o=Math.abs(n.heading-i.heading),r=Cesium.JulianDate.addSeconds(t,o/this.rotateSpeed,new Cesium.JulianDate);e.addSample(r,this.position)}this.positionProperty=e},Se.prototype.getOrientation=function(e){let t;return 1===this.state?t=this.currentQuaternion:(t=this.orientationProperty.getValue(e),this.currentQuaternion=t,void 0===this.currentQuaternion&&(this.currentQuaternion=this.endQuaternion)),t},Se.prototype.stopOrientation=function(){this.state=1},Se.prototype.restartOrientation=function(){this.state=0,this.uptateOrientationProperty()},Se.prototype.resetOrientation=function(){this.currentQuaternion=this.startQuaternion},Se.prototype.uptateOrientationProperty=function(){if(this.type===Se.Type.line){let e=new Cesium.VelocityOrientationProperty(this.positionProperty);this.orientationProperty=e}if(this.type===Se.Type.rotate){let e=new Pe,t=Cesium.JulianDate.fromDate(new Date);e.addSample(t,this.currentQuaternion);let i=Cesium.HeadingPitchRoll.fromQuaternion(this.currentQuaternion),n=Cesium.HeadingPitchRoll.fromQuaternion(this.endQuaternion),o=Math.abs(n.heading-i.heading),r=Cesium.JulianDate.addSeconds(t,o/this.rotateSpeed,new Cesium.JulianDate);e.addSample(r,this.endQuaternion),this.orientationProperty=e}},Se.prototype.isDestroy=function(){let e=!1;if(this.type===Se.Type.line&&(this.currentPosition,Math.sqrt(Math.pow(this.currentPosition.x-this.endPosition.x,2)+Math.pow(this.currentPosition.y-this.endPosition.y,2)+Math.pow(this.currentPosition.z-this.endPosition.z,2))<1&&(e=!0)),this.type===Se.Type.rotate){let t=Cesium.HeadingPitchRoll.fromQuaternion(this.currentQuaternion),i=Cesium.HeadingPitchRoll.fromQuaternion(this.endQuaternion);Math.abs(i.heading-t.heading)<6&&(e=!0)}return e},Pe.prototype.addSample=function(e,t){this.times.push(e),this.quaternions.push(t)},Pe.prototype.getValue=function(e,t){let i,n,o,r,a=new Cesium.Quaternion;if(0!==this.times.length){if(1===this.times.length)return this.quaternions[0];for(let t=0;t<this.times.length;t++)if(0!==t){if(n=this.times[t],r=this.quaternions[t],e.dayNumber+e.secondsOfDay>=i.dayNumber+i.secondsOfDay&&e.dayNumber+e.secondsOfDay<=n.dayNumber+n.secondsOfDay){let t=(e.dayNumber+e.secondsOfDay-(i.dayNumber+i.secondsOfDay))/(n.dayNumber+n.secondsOfDay-(i.dayNumber+i.secondsOfDay));Cesium.Quaternion.lerp(o,r,t,a);break}i=n,o=r}else if(i=this.times[0],o=this.quaternions[0],i.dayNumber+i.secondsOfDay>e.dayNumber+e.secondsOfDay)return;return a}};var Te={MenuItems:[{id:"location",icon:"",text:"定位",beginGroup:!0,visible:!1},{id:"polygon",icon:"",text:"载入图斑",visible:!1},{id:"bound",icon:"",text:"载入边界",visible:!1},{id:"line",icon:"",text:"载入线条",visible:!1},{id:"point",icon:"",text:"载入点位",visible:!1},{id:"text",icon:"",text:"载入标注",visible:!1},{id:"table",icon:"rowField",text:"打开属性表",beginGroup:!0,visible:!1},{id:"param",icon:"favorites",text:"符号系统",visible:!1}],getMenuData(e){let t=JSON.parse(JSON.stringify(this.MenuItems));switch(e.map_type){case"wmts":case"layer-xyz-3857":case"wms":t[0].visible=!0,t[8].visible=!0;break;case"mvt":{e.properties.table;let i=e.properties.layer_type;t[0].visible=!0,"polygon"===i&&(t[1].visible=!0,t[2].visible=!0),"line"===i&&(t[3].visible=!0),t[5].visible=!0,t[6].visible=!0,t[7].visible=!0}break;case"arcgisMapserver":case"dem":case"3Dtiles":case"shape_postgis":break;default:t=[]}return t}};const De={wj:"wjIcon",dataSet:"DataSetIcon",vrs:"VRSIcon",bim:"BIMIcon",las:"LASIcon",hole:"HoleIcon",pipe:"PipeIcon","3Dtiles":"TILES_3D_Icon",wms:"TILESIcon","layer-xyz-4326":"TILESIcon","layer-xyz-3857":"TILESIcon",geoserver:"TILESIcon",dem:"DEMIcon",shp_polygon:"PolygonFill_Icon",shp_line:"BrokenLine_Icon",shp_point:"Points_Icon",isoline:"ISOLineIcon",lct:"lct_Icon",wanderingThrough:"myllIcon",flightPath:"fxljIcon",oneCarRoaming:"rcmyIcon",surroundingBrowse:"hrllIcon",thematicData:"ztsjIcon",drillingData:"zksjIcon",BIMData:"bimIcon",formationModelData:"dcmxIcon",geologicalModelAnalysis:"dzmxfxIcon",stratigraphicModel:"dcjmIcon",peelingAnalysis:"bcfxIcon",tunnelAnalysis:"sdfxIcon",excavationAnalysis:"kwfxIcon",cuttingAnalysis:"pqfxIcon",fenceProfile:"slpmIcon",profile:"pmtIcon",surfaceWaveVelocityAnalysis:"mbsfxIcon",rectangularModel:"jxmxIcon",highlySplittings:"gdbpIcon",waveSplittings:"bsbpIcon",digAnalysis:"wkfxIcon",pointCloudAnalysis:"dyfxIcon",graphicData:"txsjIcon",set:"setIcon",weatherEffects:"tqxgIcon",query:"cxIcon",statistical:"tjIcon",appendageClassification:"fswfltjIcon",pipeClasses:"glfltjIcon",PipeDiameter:"gjfltjIcon",visual:"ksyIcon",coverage:"tcglIcon","modelManagement ":"mxglIcon",externalData:"wbsjIcon"},Me={bim:"建筑模型",las:"点云","3DTiles":"三维模型","layer-wms":"图层","layer-wmts":"图层","layer-arcgisMapServer":"图层","layer-xyz-4326":"图层","layer-xyz-3857":"图层","layer-geoserver":"数据",dem:"高程",shp_polygon:"矢量面",shp_line:"矢量线",shp_point:"矢量点"};let ke={globeDataCache:i,Viewer:C,ScreenSpaceHandlerMana:_,DrawShape:F,FlyToWorkspace:V,GlobalRotation:j,ParsWKB:de,TreeMana:ue,SysMathTool:N,ViewerListener:class{constructor(){this.listenCallbacks=[]}addEventListener(e,t,i){return!this.listenCallbacks.find((n=>n.listenType===e&&n.callback===t&&n.scope===i))&&(this.listenCallbacks.push({listenType:e,callback:t,scope:i}),!0)}triggerEvent(e,t){this.listenCallbacks.forEach((i=>{i.listenType===e&&"function"==typeof i.callback?i.callback(t):console.log("无法触发监听方法：",i.callback)}))}removeListen(e){return!!this.listenCallbacks.find((t=>t.callback===e))&&(this.listenCallbacks=this.listenCallbacks.filter((t=>t.callback!==e)),!0)}},restMap:function(e){e.commit("resetLegend"),e.commit("resetTimeAxis"),e.commit("reSetWindows")},FlyMana:Ce,SceneTool:g,EntityFactory:h,MeasureTool:class{constructor(e){this.viewer=e,this.dataSourceToo=new o.CustomDataSource("测量工具-实体集合"),e.dataSources.add(this.dataSourceToo),this.entityFactory=new h(e,this.dataSourceToo),this.drawShape=new F(e)}CesiumTriangle(){}measureTriangle(){let e=this;e.drawShape.drawTriangle({endCallback:function(t){if(3===t.length){for(let i in t)e.dataSourceToo.entities.add(Ee(t[i]));e.dataSourceToo.entities.add(function(e){return new o.Entity({polyline:{positions:e,width:3,clampToGround:!0,arcType:o.ArcType.RHUMB,material:o.Color.GREEN}})}(t));let i=N.calculateTriangle(t).toFixed(3)+"度";e.dataSourceToo.entities.add(function(e,t){return new o.Entity({position:e,label:{text:t,font:"16pt monospace",color:o.Color.RED,backgroundColor:o.Color.RED,style:o.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,heightReference:o.HeightReference.NONE,verticalOrigin:o.VerticalOrigin.TOP,pixelOffset:new o.Cartesian2(30,-30)}})}(t[1],i))}}})}verticalDistance(){let e=this;e.removeAll();let t,i,n=[],r=null,a=null,{handler:s}=_.getHandle(e.viewer,(function(){}));s.setInputAction((function(i){a=e.viewer.scene.pickPosition(i.endPosition),o.defined(a)&&n.length>=2&&(o.defined(r)?(n.pop(),n.push(a)):r=new l(n),t=function(e){let t=o.Cartographic.fromCartesian(e[0]);return(o.Cartographic.fromCartesian(e[1]).height-t.height).toFixed(2)}(n))}),o.ScreenSpaceEventType.MOUSE_MOVE),s.setInputAction((function(t){a=e.viewer.scene.pickPosition(t.position),o.defined(a)&&0==n.length&&(n.push(a.clone()),n.push(a),i=e.entityFactory.PointLabelEntity(n[0],"0米"))}),o.ScreenSpaceEventType.LEFT_CLICK),s.setInputAction((function(i){if(s.destroy(),2===n.length){let i=t+"米",s=o.Cartographic.fromCartesian(n[0]),l=o.Cartographic.fromCartesian(n[1]),c=o.Cartesian3.fromDegrees(o.Math.toDegrees(s.longitude),o.Math.toDegrees(s.latitude),l.height);e.entityFactory.PointLabelEntity(c,i),n=[],r=null,t="0米",a=null}}),o.ScreenSpaceEventType.RIGHT_CLICK);class l{constructor(e){this.options={name:"直线",polyline:{show:!0,positions:[],material:o.Color.AQUA,depthFailMaterial:new o.PolylineOutlineMaterialProperty({color:o.Color.RED}),width:2},ellipse:{show:!0,semiMinorAxis:5,semiMajorAxis:5,material:o.Color.GREEN.withAlpha(.7),outline:!0}},this.positions=e,this._init()}_init(){let t=this,i=function(){let e=o.Cartographic.fromCartesian(t.positions[0]),i=o.Cartographic.fromCartesian(t.positions[1]),n=new o.EllipsoidGeodesic;return n.setEndPoints(e,i),n.surfaceDistance};this.options.polyline.positions=new o.CallbackProperty((function(){let e=[];e.push(t.positions[0]);let i=o.Cartographic.fromCartesian(t.positions[0]),n=o.Cartographic.fromCartesian(t.positions[1]),r=o.Cartesian3.fromDegrees(o.Math.toDegrees(i.longitude),o.Math.toDegrees(i.latitude),n.height);return e.push(r),e}),!1),this.options.position=new o.CallbackProperty((function(){return t.positions[0]}),!1),this.options.ellipse.semiMinorAxis=new o.CallbackProperty(i,!1),this.options.ellipse.semiMajorAxis=new o.CallbackProperty(i,!1),this.options.ellipse.height=new o.CallbackProperty((function(){let e=function(e){return o.Cartographic.fromCartesian(e[1]).height.toFixed(2)}(t.positions);return e}),!1),e.dataSourceToo.entities.add(this.options)}}}spaceDistance(){let e=this,t=0;this.drawShape.drawPolyLine({endCallback:function(i){if(i.length>=2){for(let t in i)e.dataSourceToo.entities.add({position:i[t],point:{pixelSize:6,color:o.Color.WHITE}});if(e.dataSourceToo.entities.add({polyline:{positions:i,width:3,clampToGround:!0,arcType:o.ArcType.RHUMB,material:o.Color.GREEN}}),i.length>=2&&i.length-1>t){t++;let n=i[i.length-1],o=i[i.length-2];e.entityFactory.spaceDistanceLabel(n,o)}}},errCallback:function(i){if(i.length>2&&i.length-2>t){t++;let n=i[i.length-2],o=i[i.length-3];e.entityFactory.spaceDistanceLabel(n,o)}}})}measureHeight(){let e=this;e.drawShape.drawPoint({endCallback:function(t){let i=new o.Cartographic.fromCartesian(t[0]),n=(e.viewer.scene.sampleHeight(i)||0).toFixed(3)+" m",r=Ee(t[0]),a=e.entityFactory.buildLabel(t[0],n);e.dataSourceToo.entities.add(r),e.dataSourceToo.entities.add(a)}})}surfaceArea(){let e=this;e.viewer,this.drawShape.drawPolygon({endCallback:function(t){if(t.length>3){e.dataSourceToo.entities.add({polygon:{hierarchy:t,material:o.Color.BLUEVIOLET.withAlpha(.5)}});for(let i=0;i<t.length-1;i++)e.dataSourceToo.entities.add({position:t[i],point:{pixelSize:5,color:o.Color.RED,outlineColor:o.Color.WHITE,outlineWidth:2}});let i=[];for(let e=0;e<t.length;e++)i.push(o.Cartographic.fromCartesian(new o.Cartesian3(t[e].x,t[e].y,t[e].z),o.Ellipsoid.WGS84,new o.Cartographic));let n=[];for(let e=0;e<i.length;e++){let t=i[e].longitude/Math.PI*180,o=i[e].latitude/Math.PI*180;n.push([t,o])}let r={type:"Polygon"};r.coordinates=[n],e.entityFactory.polygonCenterLabel(r,"面积")}else console.error("绘制失败")}})}perimeter(){let e=this;e.viewer,this.drawShape.drawPolygon({endCallback:function(t){if(t.length>3){e.dataSourceToo.entities.add({polygon:{hierarchy:t,material:o.Color.BLUEVIOLET.withAlpha(.5)}});for(let i=0;i<t.length-1;i++)e.dataSourceToo.entities.add(Ee(t[i]));let i=[];for(let e=0;e<t.length;e++)i.push(o.Cartographic.fromCartesian(new o.Cartesian3(t[e].x,t[e].y,t[e].z),o.Ellipsoid.WGS84,new o.Cartographic));let n=[];for(let e=0;e<i.length;e++){let t=i[e].longitude/Math.PI*180,o=i[e].latitude/Math.PI*180;n.push([t,o])}let r={type:"Polygon"};r.coordinates=[n],e.entityFactory.polygonCenterLabel(r,"周长")}else console.error("绘制失败")}})}profileAnalysis(){}visiableSelectPoint(){}removeAll(){this.dataSourceToo.entities.removeAll()}},ViewShedStage:class{constructor(e,t){this.viewer=e,this.viewPosition=t.viewPosition,this.viewPositionEnd=t.viewPositionEnd,this.viewDistance=this.viewPositionEnd?o.Cartesian3.distance(this.viewPosition,this.viewPositionEnd):t.viewDistance||100,this.viewHeading=this.viewPositionEnd?this.getHeading(this.viewPosition,this.viewPositionEnd):t.viewHeading||0,this.viewPitch=this.viewPositionEnd?this.getPitch(this.viewPosition,this.viewPositionEnd):t.viewPitch||0,this.horizontalViewAngle=t.horizontalViewAngle||90,this.verticalViewAngle=t.verticalViewAngle||60,this.visibleAreaColor=t.visibleAreaColor||o.Color.GREEN,this.invisibleAreaColor=t.invisibleAreaColor||o.Color.RED,this.enabled="boolean"!=typeof t.enabled||t.enabled,this.softShadows="boolean"!=typeof t.softShadows||t.softShadows,this.size=t.size||1024,this.update()}update(){this.clear(),this.createLightCamera(),this.createShadowMap(),this.createPostStage(),this.drawFrustumOutline(),this.drawSketch()}clear(){this.sketch&&(this.viewer.entities.removeById(this.sketch.id),this.sketch=null),this.frustumOutline&&(this.frustumOutline.destroy(),this.frustumOutline=null),this.postStage&&(this.viewer.scene.postProcessStages.remove(this.postStage),this.postStage=null)}createLightCamera(){this.lightCamera=new o.Camera(this.viewer.scene),this.lightCamera.position=this.viewPosition,this.lightCamera.frustum.near=.001*this.viewDistance,this.lightCamera.frustum.far=this.viewDistance;const e=o.Math.toRadians(this.horizontalViewAngle),t=o.Math.toRadians(this.verticalViewAngle),i=this.viewDistance*Math.tan(e/2)*2/(this.viewDistance*Math.tan(t/2)*2);this.lightCamera.frustum.aspectRatio=i,this.lightCamera.frustum.fov=e>t?e:t,this.lightCamera.setView({destination:this.viewPosition,orientation:{heading:o.Math.toRadians(this.viewHeading||0),pitch:o.Math.toRadians(this.viewPitch||0),roll:0}})}createShadowMap(){this.shadowMap=new o.ShadowMap({context:this.viewer.scene.context,lightCamera:this.lightCamera,enabled:this.enabled,isPointLight:!0,pointLightRadius:this.viewDistance,cascadesEnabled:!1,size:this.size,softShadows:this.softShadows,normalOffset:!1,fromLightSource:!1}),this.viewer.scene.shadowMap=this.shadowMap}createPostStage(){const e=new o.PostProcessStage({fragmentShader:"\n #define USE_CUBE_MAP_SHADOW true\n uniform sampler2D colorTexture;\n uniform sampler2D depthTexture;\n varying vec2 v_textureCoordinates;\n uniform mat4 camera_projection_matrix;\n uniform mat4 camera_view_matrix;\n uniform samplerCube shadowMap_textureCube;\n uniform mat4 shadowMap_matrix;\n uniform vec4 shadowMap_lightPositionEC;\n uniform vec4 shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness;\n uniform vec4 shadowMap_texelSizeDepthBiasAndNormalShadingSmooth;\n uniform float helsing_viewDistance;\n uniform vec4 helsing_visibleAreaColor;\n uniform vec4 helsing_invisibleAreaColor;\n struct zx_shadowParameters\n {\n     vec3 texCoords;\n     float depthBias;\n     float depth;\n     float nDotL;\n     vec2 texelStepSize;\n     float normalShadingSmooth;\n     float darkness;\n };\n float czm_shadowVisibility(samplerCube shadowMap, zx_shadowParameters shadowParameters)\n {\n     float depthBias = shadowParameters.depthBias;\n     float depth = shadowParameters.depth;\n     float nDotL = shadowParameters.nDotL;\n     float normalShadingSmooth = shadowParameters.normalShadingSmooth;\n     float darkness = shadowParameters.darkness;\n     vec3 uvw = shadowParameters.texCoords;\n     depth -= depthBias;\n     float visibility = czm_shadowDepthCompare(shadowMap, uvw, depth);\n     return czm_private_shadowVisibility(visibility, nDotL, normalShadingSmooth, darkness);\n }\n vec4 getPositionEC(){\n     return czm_windowToEyeCoordinates(gl_FragCoord);\n }\n vec3 getNormalEC(){\n     return vec3(1.);\n }\n vec4 toEye(in vec2 uv,in float depth){\n     vec2 xy=vec2((uv.x*2.-1.),(uv.y*2.-1.));\n     vec4 posInCamera=czm_inverseProjection*vec4(xy,depth,1.);\n     posInCamera=posInCamera/posInCamera.w;\n     return posInCamera;\n }\n vec3 pointProjectOnPlane(in vec3 planeNormal,in vec3 planeOrigin,in vec3 point){\n     vec3 v01=point-planeOrigin;\n     float d=dot(planeNormal,v01);\n     return(point-planeNormal*d);\n }\n float getDepth(in vec4 depth){\n     float z_window=czm_unpackDepth(depth);\n     z_window=czm_reverseLogDepth(z_window);\n     float n_range=czm_depthRange.near;\n     float f_range=czm_depthRange.far;\n     return(2.*z_window-n_range-f_range)/(f_range-n_range);\n }\n float shadow(in vec4 positionEC){\n     vec3 normalEC=getNormalEC();\n     zx_shadowParameters shadowParameters;\n     shadowParameters.texelStepSize=shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.xy;\n     shadowParameters.depthBias=shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.z;\n     shadowParameters.normalShadingSmooth=shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.w;\n     shadowParameters.darkness=shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness.w;\n     vec3 directionEC=positionEC.xyz-shadowMap_lightPositionEC.xyz;\n     float distance=length(directionEC);\n     directionEC=normalize(directionEC);\n     float radius=shadowMap_lightPositionEC.w;\n     if(distance>radius)\n     {\n         return 2.0;\n     }\n     vec3 directionWC=czm_inverseViewRotation*directionEC;\n     shadowParameters.depth=distance/radius-0.0003;\n     shadowParameters.nDotL=clamp(dot(normalEC,-directionEC),0.,1.);\n     shadowParameters.texCoords=directionWC;\n     float visibility=czm_shadowVisibility(shadowMap_textureCube,shadowParameters);\n     return visibility;\n }\n bool visible(in vec4 result)\n {\n     result.x/=result.w;\n     result.y/=result.w;\n     result.z/=result.w;\n     return result.x>=-1.&&result.x<=1.\n     &&result.y>=-1.&&result.y<=1.\n     &&result.z>=-1.&&result.z<=1.;\n }\n void main(){\n     // 釉色 = 结构二维(颜色纹理, 纹理坐标)\n     gl_FragColor = texture2D(colorTexture, v_textureCoordinates);\n     // 深度 = 获取深度(结构二维(深度纹理, 纹理坐标))\n     float depth = getDepth(texture2D(depthTexture, v_textureCoordinates));\n     // 视角 = (纹理坐标, 深度)\n     vec4 viewPos = toEye(v_textureCoordinates, depth);\n     // 世界坐标\n     vec4 wordPos = czm_inverseView * viewPos;\n     // 虚拟相机中坐标\n     vec4 vcPos = camera_view_matrix * wordPos;\n     float near = .001 * helsing_viewDistance;\n     float dis = length(vcPos.xyz);\n     if(dis > near && dis < helsing_viewDistance){\n         // 透视投影\n         vec4 posInEye = camera_projection_matrix * vcPos;\n         // 可视区颜色\n         // vec4 helsing_visibleAreaColor=vec4(0.,1.,0.,.5);\n         // vec4 helsing_invisibleAreaColor=vec4(1.,0.,0.,.5);\n         if(visible(posInEye)){\n             float vis = shadow(viewPos);\n             if(vis > 0.3){\n                 gl_FragColor = mix(gl_FragColor,helsing_visibleAreaColor,.5);\n             } else{\n                 gl_FragColor = mix(gl_FragColor,helsing_invisibleAreaColor,.5);\n             }\n         }\n     }\n }",uniforms:{shadowMap_textureCube:()=>(this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState")),Reflect.get(this.shadowMap,"_shadowMapTexture")),shadowMap_matrix:()=>(this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState")),Reflect.get(this.shadowMap,"_shadowMapMatrix")),shadowMap_lightPositionEC:()=>(this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState")),Reflect.get(this.shadowMap,"_lightPositionEC")),shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness:()=>{this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState"));const e=this.shadowMap._pointBias;return o.Cartesian4.fromElements(e.normalOffsetScale,this.shadowMap._distance,this.shadowMap.maximumDistance,0,new o.Cartesian4)},shadowMap_texelSizeDepthBiasAndNormalShadingSmooth:()=>{this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState"));const e=this.shadowMap._pointBias,t=new o.Cartesian2;return t.x=1/this.shadowMap._textureSize.x,t.y=1/this.shadowMap._textureSize.y,o.Cartesian4.fromElements(t.x,t.y,e.depthBias,e.normalShadingSmooth,new o.Cartesian4)},camera_projection_matrix:this.lightCamera.frustum.projectionMatrix,camera_view_matrix:this.lightCamera.viewMatrix,helsing_viewDistance:()=>this.viewDistance,helsing_visibleAreaColor:this.visibleAreaColor,helsing_invisibleAreaColor:this.invisibleAreaColor}});this.postStage=this.viewer.scene.postProcessStages.add(e)}drawFrustumOutline(){const e=new o.Cartesian3,t=new o.Matrix3,i=new o.Quaternion,n=(this.lightCamera.positionWC,this.lightCamera.directionWC),r=this.lightCamera.upWC;let a=this.lightCamera.rightWC;a=o.Cartesian3.negate(a,e);let s=t;o.Matrix3.setColumn(s,0,a,s),o.Matrix3.setColumn(s,1,r,s),o.Matrix3.setColumn(s,2,n,s);let l=o.Quaternion.fromRotationMatrix(s,i),c=new o.GeometryInstance({geometry:new o.FrustumOutlineGeometry({frustum:this.lightCamera.frustum,origin:this.viewPosition,orientation:l}),id:Math.random().toString(36).substr(2),attributes:{color:o.ColorGeometryInstanceAttribute.fromColor(o.Color.YELLOWGREEN),show:new o.ShowGeometryInstanceAttribute(!0)}});this.frustumOutline=this.viewer.scene.primitives.add(new o.Primitive({geometryInstances:[c],appearance:new o.PerInstanceColorAppearance({flat:!0,translucent:!1})}))}drawSketch(){this.sketch=this.viewer.entities.add({name:"sketch",position:this.viewPosition,orientation:o.Transforms.headingPitchRollQuaternion(this.viewPosition,o.HeadingPitchRoll.fromDegrees(this.viewHeading-90,this.viewPitch,0)),ellipsoid:{radii:new o.Cartesian3(this.viewDistance,this.viewDistance,this.viewDistance),minimumClock:o.Math.toRadians(-this.horizontalViewAngle/2),maximumClock:o.Math.toRadians(this.horizontalViewAngle/2),minimumCone:o.Math.toRadians(90-this.verticalViewAngle),maximumCone:o.Math.toRadians(90+this.verticalViewAngle),fill:!1,outline:!0,subdivisions:256,stackPartitions:64,slicePartitions:64,outlineColor:o.Color.YELLOWGREEN}})}getHeading(e,t){let i=new o.Cartesian3,n=o.Transforms.eastNorthUpToFixedFrame(e);return o.Matrix4.inverse(n,n),o.Matrix4.multiplyByPoint(n,t,i),o.Cartesian3.normalize(i,i),o.Math.toDegrees(Math.atan2(i.x,i.y))}getPitch(e,t){let i=new o.Cartesian3,n=o.Transforms.eastNorthUpToFixedFrame(e);return o.Matrix4.inverse(n,n),o.Matrix4.multiplyByPoint(n,t,i),o.Cartesian3.normalize(i,i),o.Math.toDegrees(Math.asin(i.z))}},ScreenEvent:w,WorkSpace:m,WorkspaceContextMenu:Te,VGE3DTilesMana:class{constructor(){this.listenCallbacks=[]}addEventListener(e,t,i){return!this.listenCallbacks.find((n=>n.listenType===e&&n.callback===t&&n.scope===i))&&(this.listenCallbacks.push({listenType:e,callback:t,scope:i}),!0)}triggerEvent(e,t){this.listenCallbacks.forEach((i=>{i.listenType===e&&"function"==typeof i.callback?i.callback(t):console.log("无法触发监听方法：",i.callback)}))}removeListen(e){return!!this.listenCallbacks.find((t=>t.callback===e))&&(this.listenCallbacks.filter((t=>t.callback===e)),!0)}},VGEImageryLayerMana:class{constructor(){this.listenCallbacks=[]}addEventListener(e,t,i){return!this.listenCallbacks.find((n=>n.listenType===e&&n.callback===t&&n.scope===i))&&(this.listenCallbacks.push({listenType:e,callback:t,scope:i}),!0)}triggerEvent(e,t){this.listenCallbacks.forEach((i=>{i.listenType===e&&"function"==typeof i.callback?i.callback(t):console.log("无法触发监听方法：",i.callback)}))}removeListen(e){return!!this.listenCallbacks.find((t=>t.callback===e))&&(this.listenCallbacks=this.listenCallbacks.filter((t=>t.callback!==e)),!0)}},WorkSpaceConfig:{getIcon:e=>De[e],getName:e=>Me[e]},MotionEntity:u,getMainViewer:function(){return i.viewerLeft},ConfigTool:c,getConfig:c.getConfig};window.VGEEarth=ke,console.log("%cVGEEarth：当前接口版本：v"+i.version,"color: green;");var Ie=ke;return t}()}));